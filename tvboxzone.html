<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Box Zone TV</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet">
<style>
/* === AJUSTES DE TEMA OSCURO (MORADO) === */
/* Fondo Morado Oscuro y Texto Blanco/Claro */
body { 
    background-color: #4B0082; /* Fondo Púrpura/Morado Oscuro (Originalmente usabas un color similar) */
    color: #e2e8f0; /* Texto principal Gris Claro */
    font-family: 'Roboto', sans-serif; 
    padding:20px; 
    margin:0; 
    display:flex; 
    flex-direction:column; 
    overflow-x:hidden;
}
h1 { 
    font-size:40px; 
    margin-bottom:25px; 
    text-align:center; 
    color:#ffffff; /* Título Blanco */
}
h2 { 
    font-size:28px; 
    margin-top:35px; 
    margin-bottom:15px; 
    border-bottom:2px solid #6a0dad; /* Separador Morado Ligeramente más Claro */
    padding-bottom:8px; 
    color:#ffffff; /* Categoría Blanco */
    padding-left:10px;
}
.fila { 
    display:flex; 
    gap:15px; 
    overflow-x:auto; 
    overflow-y:hidden; 
    margin-bottom:25px; 
    padding-bottom:10px; 
    scroll-behavior:smooth; 
    -webkit-overflow-scrolling:touch;
}
.fila::-webkit-scrollbar { height:8px;}
.fila::-webkit-scrollbar-thumb { background-color: rgba(255,255,255,0.2); border-radius:4px;}

/* Estilo del Item */
.item { 
    flex-shrink:0; 
    width:130px; 
    background:#2d004d; /* Fondo de Ítem Morado Muy Oscuro */
    padding:10px; 
    border-radius:10px; 
    text-align:center; 
    cursor:pointer; 
    transition:transform 0.15s ease, border 0.15s ease; 
    white-space:normal; 
    position:relative; 
    border:4px solid transparent;
}
.item img { 
    width:100%; 
    height:90px; 
    object-fit:cover; 
    border-radius:8px;
}
.item p { 
    margin:8px 0 0; 
    font-size:14px; 
    font-weight:400; 
    color:#ffffff; /* Nombre del Ítem Blanco */
    overflow:hidden; 
    text-overflow:ellipsis; 
    display:-webkit-box; 
    -webkit-line-clamp:2; 
    -webkit-box-orient:vertical;
}
/* Foco Rojo/Naranja Vibrante sobre fondo oscuro */
.item:focus { 
    outline:none; 
    transform:scale(1.15); 
    border:4px solid #ff4500; /* Borde de Foco Naranja/Rojo Vibrante */
    z-index:10;
}

/* === FIN AJUSTES DE TEMA MORADO === */
</style>
</head>
<body>
<h1>Box Zone TV</h1>
<div id="contenido"></div>

<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
<script>
var firebaseConfig = {
    apiKey: "AIzaSyD6Tj5S2TvV_k8jq0P4ET_Mxo_YgoWtBwo",
    authDomain: "chunito-d25bb.firebaseapp.com",
    projectId: "chunito-d25bb",
    databaseURL: "https://chunito-d25bb-default-rtdb.firebaseio.com",
    storageBucket: "chunito-d25bb.appspot.com",
    messagingSenderId: "748622352005",
    appId: "1:748622352005:web:f9ea6d2da8af92f76123ec"
};
firebase.initializeApp(firebaseConfig);
var db = firebase.database();
var ref = db.ref("novedades");
var contenedor = document.getElementById("contenido");

var estructura = [];
var itemsFocus = [];
var filaFocus = 0;
var itemFocus = 0;

function esDispositivoBasico(){
    var ua = navigator.userAgent.toLowerCase();
    return ua.includes("rockchip") || ua.includes("amlogic") || ua.includes("s905") || ua.includes("s912");
}

function reproducirDirecto(item){
    var urlFinal = item.url;
    if(esDispositivoBasico() && item.url_sd) urlFinal = item.url_sd;
    window.location.href = urlFinal;
}

document.addEventListener('keydown', function(e){
    if(itemsFocus.length===0 || !itemsFocus[filaFocus]) return;
    var nextFila = filaFocus; var nextItem = itemFocus;

    if(e.key==="ArrowRight") nextItem=Math.min(itemFocus+1,itemsFocus[filaFocus].length-1);
    else if(e.key==="ArrowLeft") nextItem=Math.max(itemFocus-1,0);
    else if(e.key==="ArrowDown"){ nextFila=Math.min(filaFocus+1,itemsFocus.length-1); if(itemsFocus[nextFila]&&itemFocus>=itemsFocus[nextFila].length) nextItem=itemsFocus[nextFila].length-1; else nextItem=itemFocus;}
    else if(e.key==="ArrowUp"){ nextFila=Math.max(filaFocus-1,0); if(itemsFocus[nextFila]&&itemFocus>=itemsFocus[nextFila].length) nextItem=itemsFocus[nextFila].length-1; else nextItem=itemFocus;}
    else if(e.key==="Enter" || e.key===" " || e.keyCode===13){ var current=itemsFocus[filaFocus][itemFocus]; if(current) current.click(); e.preventDefault(); return;}
    else return;

    filaFocus=nextFila; itemFocus=nextItem;
    localStorage.setItem("filaFocus",filaFocus); localStorage.setItem("itemFocus",itemFocus);

    var nextElement=itemsFocus[filaFocus][itemFocus];
    if(nextElement){ nextElement.focus();
        var container=nextElement.closest('.fila');
        if(container){ var itemRect=nextElement.getBoundingClientRect(); var containerRect=container.getBoundingClientRect();
            var scrollMargin = 50; 
            if(itemRect.left < containerRect.left) container.scrollLeft -= (containerRect.left - itemRect.left) + scrollMargin;
            else if(itemRect.right > containerRect.right) container.scrollLeft += (itemRect.right - containerRect.right) + scrollMargin;
        }
    }
    e.preventDefault();
});

ref.on("value", function(snapshot){
    contenedor.innerHTML=""; estructura=[]; itemsFocus=[];
    snapshot.forEach(function(child){
        var data=child.val();
        if(data.subtitulo) estructura.push({subtitulo:data.subtitulo, items:[]});
        else if(data.titulo && estructura.length>0) estructura[estructura.length-1].items.push(data);
    });

    estructura.forEach(function(bloque){
        var subtitulo=document.createElement("h2"); subtitulo.textContent=bloque.subtitulo; contenedor.appendChild(subtitulo);
        var fila=document.createElement("div"); fila.className="fila"; var itemsEnFila=[];

        bloque.items.forEach(function(item){
            var div=document.createElement("div"); div.className="item"; div.setAttribute('tabindex','0');
            div.onclick=function(){ reproducirDirecto(item); };
            var img=document.createElement("img"); img.src=item.imagen; 
            var desc=document.createElement("p"); desc.textContent=item.descripcion||item.titulo||"";
            div.appendChild(img); div.appendChild(desc); fila.appendChild(div); itemsEnFila.push(div);
        });

        contenedor.appendChild(fila); itemsFocus.push(itemsEnFila);
    });

    let ultimoFila=localStorage.getItem("filaFocus");
    let ultimoItem=localStorage.getItem("itemFocus");

    if(ultimoFila!==null && ultimoItem!==null){ filaFocus=parseInt(ultimoFila); itemFocus=parseInt(ultimoItem);}
    if(itemsFocus[filaFocus] && itemsFocus[filaFocus][itemFocus]) itemsFocus[filaFocus][itemFocus].focus();
    else { filaFocus=0; itemFocus=0; if(itemsFocus.length>0 && itemsFocus[0].length>0) itemsFocus[0][0].focus(); }
});
</script>
</body>
</html>
