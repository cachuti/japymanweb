<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tienda Chunito</title>
    <!-- Enlace a la fuente Inter desde Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700&display=swap" rel="stylesheet">
    <!-- Enlace a Font Awesome para los iconos -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"/>
    <!-- Enlace al CDN de Tailwind CSS para estilos modernos y responsivos -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Configuración de la fuente Inter */
        body {
            font-family: 'Inter', sans-serif;
        }
        /* Configuración de Tailwind para que reconozca la fuente */
        @tailwind base;
        @tailwind components;
        @tailwind utilities;
    </style>
</head>
<body class="bg-[#0d1117] text-white flex flex-col justify-center items-center min-h-screen relative overflow-hidden">
    <!-- Botón de volver al menú principal -->
    <a href="index.html" class="back-button absolute top-5 left-5 text-xl text-white flex items-center bg-blue-500 py-2.5 px-4 rounded-lg transition-all duration-200 ease-in-out hover:bg-blue-600 hover:scale-105 focus:outline-none focus:ring-2 focus:ring-blue-400 focus:ring-opacity-75 z-10">
        <i class="fas fa-arrow-left mr-2"></i>
        <span>Volver al Menú Principal</span>
    </a>

    <div class="container w-[90%] max-w-3xl p-8 text-center">
        <!-- Título de la aplicación -->
        <h1 class="text-6xl font-bold mb-4 text-gray-300">📦 Tienda Chunito</h1>
        
        <!-- Visor de mensajes de Firebase -->
        <div id="visor" class="bg-gray-800 p-6 my-4 min-h-[200px] text-2xl overflow-y-auto rounded-2xl border-2 border-gray-700 flex items-center justify-center animate-fadeIn shadow-lg">Cargando mensajes...</div>

        <!-- Sección de búsqueda de código -->
        <div id="buscador" class="flex justify-center my-4 gap-4 w-full">
            <input type="text" id="codigoInput" maxlength="3" placeholder="Código" class="font-inter text-2xl p-3 w-32 text-center rounded-xl border-2 border-transparent bg-gray-700 text-white outline-none transition-colors duration-300 focus:border-blue-500 shadow-md">
        </div>

        <!-- Área para mostrar el resultado de la búsqueda -->
        <div id="resultado" class="text-center mt-6 text-xl"></div>
    </div>

    <!-- Scripts de Firebase Realtime Database -->
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
    
    <script>
        // Configuración de Firebase (proporcionada por el usuario)
        const firebaseConfig = {
            apiKey: "AIzaSyD6Tj5S2TvV_k8jq0P4ET_Mxo_YgoWtBwo",
            authDomain: "chunito-d25bb.firebaseapp.com",
            projectId: "chunito-d25bb",
            databaseURL: "https://chunito-d25bb-default-rtdb.firebaseio.com",
            storageBucket: "chunito-d25bb.appspot.com",
            messagingSenderId: "748622352005",
            appId: "1:748622352005:web:f9ea6d2da8af92f76123ec"
        };

        // Inicializa Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        // Obtiene referencias a los elementos del DOM
        const visor = document.getElementById("visor");
        const resultado = document.getElementById("resultado");
        const codigoInput = document.getElementById("codigoInput");
        const backButton = document.querySelector('.back-button');

        // Escucha cambios en tiempo real en el nodo "avisosTV" de la base de datos
        db.ref("avisosTV").on("value", snapshot => {
            const texto = snapshot.val();
            // Muestra el mensaje o "Sin mensajes." si no hay texto
            visor.textContent = texto || "Sin mensajes.";
        });

        // Event listener para el input del código: se activa con cada carácter ingresado
        codigoInput.addEventListener('input', function() {
            const codigo = this.value.trim();
            // Si el código tiene 3 caracteres, busca en la base de datos
            if (codigo.length === 3) {
                buscarCodigo(codigo);
            } else {
                // Si no tiene 3 caracteres, limpia el área de resultados
                resultado.innerHTML = "";
            }
        });

        /**
         * Busca un código en la rama "apk" de la base de datos de Firebase.
         * @param {string} codigo - El código de 3 caracteres a buscar.
         */
        function buscarCodigo(codigo) {
            db.ref("apk/" + codigo).once("value").then(snapshot => {
                const data = snapshot.val();
                if (data) {
                    // Si se encuentra data, muestra la descripción y procede a descargar
                    resultado.innerHTML = `<p><strong>Encontrado:</strong> ${data.descripcion}</p>`;
                    descargar(data.url);
                } else {
                    // Si no se encuentra, muestra un mensaje
                    resultado.innerHTML = "<p>No se encontró ese código.</p>";
                }
            }).catch(error => {
                console.error("Error al buscar el código:", error);
                resultado.innerHTML = "<p>Error al buscar. Intenta de nuevo.</p>";
            });
        }

        /**
         * Intenta abrir una URL como un intent de Android para descarga.
         * @param {string} url - La URL del archivo a descargar.
         */
        function descargar(url) {
            // Formatea la URL para un intent de Android
            const intentURL = `intent://${url.replace(/^https?:\/\//, '')}#Intent;action=android.intent.action.VIEW;scheme=https;end`;
            window.location.href = intentURL;
        }

        // Lógica para navegación con control de TV (teclado)
        document.addEventListener('keydown', function(e) {
            const currentFocus = document.activeElement;

            // Navegación con flechas arriba/abajo entre el botón de volver y el input
            if (e.key === "ArrowDown" || e.key === "ArrowUp") {
                e.preventDefault(); // Previene el scroll de la página
                if (currentFocus === backButton) {
                    codigoInput.focus();
                } else if (currentFocus === codigoInput) {
                    backButton.focus();
                }
            } else if (e.key === "Enter" || e.keyCode === 13) {
                // Si se presiona Enter en el botón de volver, simula un clic
                if (currentFocus === backButton) {
                    backButton.click(); // Activa la redirección del botón de volver
                }
                // Si se presiona Enter en el input, la búsqueda ya se maneja por el evento 'input'
            }
        });
        
        // Foco inicial en el botón de volver al cargar la ventana
        window.onload = () => {
            if (backButton) {
                backButton.focus();
            }
        };
    </script>
</body>
</html>



