<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Registro Box Zone</title>
    <style>
        body {
            background-color: #0f172a;
            color: #e2e8f0;
            font-family: 'Roboto', sans-serif;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            margin: 0;
            text-align: center;
        }
        h1 {
            font-size: 48px;
            margin-bottom: 40px;
        }
        input[type="text"] {
            background-color: #1e293b;
            color: #e2e8f0;
            border: 2px solid #334155;
            border-radius: 8px;
            padding: 20px;
            font-size: 24px;
            width: 80%;
            max-width: 500px;
            text-align: center;
            outline: none;
            transition: border-color 0.3s ease;
        }
        input[type="text"]:focus {
            border-color: #0ea5e9;
        }
        #mensaje {
            margin-top: 20px;
            font-size: 28px;
            font-weight: bold;
            color: #e2e8f0;
        }
        .error {
            color: #ef4444;
        }
        .success {
            color: #22c55e;
        }
    </style>
</head>
<body>
    <div>
        <h1>Registro Box Zone</h1>
        <input type="text" id="usuarioInput" placeholder="Introduce tu nombre de usuario" style="display: none;">
        <p id="mensaje">Verificando usuario...</p>
    </div>

    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <script>
        var firebaseConfig = {
            apiKey: "AIzaSyD6Tj5S2TvV_k8jq0P4ET_Mxo_YgoWtBwo",
            authDomain: "chunito-d25bb.firebaseapp.com",
            projectId: "chunito-d25bb",
            databaseURL: "https://chunito-d25bb-default-rtdb.firebaseio.com",
            storageBucket: "chunito-d25bb.appspot.com",
            messagingSenderId: "748622352005",
            appId: "1:748622352005:web:f9ea6d2da8af92f76123ec"
        };
        firebase.initializeApp(firebaseConfig);
        var db = firebase.database();
        var refUsuarios = db.ref("users");

        var usuarioInput = document.getElementById("usuarioInput");
        var mensaje = document.getElementById("mensaje");
        var timeoutId;

        // URL completa de tu TV HTML
        var tvUrl = "https://tusuario.github.io/BoxZone/tv.html";

        function loginUsuario(usuario, isNewLogin = true) {
            refUsuarios.child(usuario).once("value", function(snapshot) {
                var userData = snapshot.val();
                if (!userData) {
                    mensaje.textContent = "Usuario no encontrado.";
                    mensaje.className = "error";
                    localStorage.removeItem('lastUser');
                    usuarioInput.style.display = 'block';
                    usuarioInput.focus();
                } else if (!userData.enabled) {
                    mensaje.textContent = "Tu usuario no está habilitado.";
                    mensaje.className = "error";
                    localStorage.removeItem('lastUser');
                    usuarioInput.style.display = 'block';
                    usuarioInput.focus();
                } else if (isNewLogin && userData.ingresos <= 0) {
                    mensaje.textContent = "No tienes más ingresos disponibles.";
                    mensaje.className = "error";
                    localStorage.removeItem('lastUser');
                    usuarioInput.style.display = 'block';
                    usuarioInput.focus();
                } else {
                    mensaje.textContent = `¡Bienvenido, ${userData.name}!`;
                    mensaje.className = "success";
                    
                    setTimeout(function() {
                        if (isNewLogin) {
                            refUsuarios.child(usuario).child("ingresos").transaction(currentIngresos => {
                                return (currentIngresos || 0) - 1;
                            }, (error, committed, snapshot) => {
                                if (committed) {
                                    window.location.href = tvUrl; // redirige al TV HTML
                                }
                            });
                        } else {
                            window.location.href = tvUrl; // redirige al TV HTML
                        }
                    }, 1500);
                }
            });
        }

        var lastUser = localStorage.getItem('lastUser');
        if (lastUser) {
            loginUsuario(lastUser, false); 
        } else {
            mensaje.textContent = "";
            usuarioInput.style.display = 'block';
            usuarioInput.focus();
        }

        usuarioInput.addEventListener('input', function() {
            clearTimeout(timeoutId);
            var usuario = usuarioInput.value.toLowerCase();
            if (usuario.length === 0) {
                mensaje.textContent = "";
                return;
            }

            timeoutId = setTimeout(function() {
                localStorage.setItem('lastUser', usuario);
                loginUsuario(usuario, true); 
            }, 500);
        });
    </script>
</body>
</html>
