<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Box Zone TV - Foco en Reproducir</title>
<style>
/* Estilos CSS Corregidos para el Look Original */
body { margin:0; background:#4B0082; color:#fff; font-family:Arial, sans-serif; overflow-x:hidden; }

/* Slider fijo */
.slider { width:100%; height:400px; background:#222; position:fixed; top:0; left:0; z-index:0; display:flex; justify-content:center; align-items:center; }
.slider img { width:100%; height:100%; object-fit:cover; }

/* Lupa - Contenedor principal enfocable */
#buscador { 
    position:fixed; 
    top:10px; 
    left:50%; 
    transform:translateX(-50%); 
    z-index:10; 
    display:flex; 
    gap:5px; 
    padding: 5px; 
    border-radius: 6px;
    outline: 2px solid transparent; 
    transition: outline 0.2s;
    background: rgba(0,0,0,0.3); 
}

/* Estilo de foco para el contenedor de la lupa (el que se selecciona) */
#buscador:focus {
    outline: 2px solid yellow; /* Borde amarillo al ser seleccionado */
}

/* El input y bot칩n internos ya no necesitan tabindex */
#buscador input { 
    padding:10px; 
    width:250px; 
    border-radius:6px; 
    border:none; 
    font-size:16px; 
    outline: none; /* Aseguramos que el input no muestre su propio foco */
}
#buscador button { 
    padding:10px 15px; 
    border:none; 
    border-radius:6px; 
    cursor:pointer; 
    font-size:16px; 
    font-weight:bold; 
    background:#28a745; 
    color:#fff; 
}

/* Contenedor de Categor칤a fija abajo */
.categorias { 
    position: fixed; 
    bottom: 0; 
    left: 0; 
    width: 100%; 
    z-index: 2; 
    padding: 10px 20px 20px 20px;
    background: transparent; 
}
.categoria { 
    margin-bottom: 20px; 
    display: none; 
}
.categoria.active { 
    display: block !important; 
}

.categoria h2 { margin:10px 0; }

/* El carrusel de items */
.items {
    display: flex;
    gap: 15px;
    overflow-x: auto; 
    scroll-snap-type: x mandatory; 
    padding-bottom: 10px;
    max-height: 260px;
    -ms-overflow-style: none; 
    scrollbar-width: none; 
}
.items::-webkit-scrollbar {
    display: none;
}

.item {
    flex: 0 0 auto;
    width: 160px;
    height: 260px;
    background: #111;
    border-radius: 8px;
    cursor: pointer;
    display: flex;
    flex-direction: column;
    align-items: center;
    outline: none;
    scroll-snap-align: start; 
    transition: border 0.2s, transform 0.2s;
}

.item img { width:100%; height:200px; object-fit:cover; border-radius:8px; }
.item span { margin-top:5px; text-align:center; font-size:14px; color:#fff; background:none; padding: 0 5px;}
.item:focus { 
    border:2px solid #ff0000; 
    transform: scale(1.05); 
}

/* Modal */
.modal { display:none; position:fixed; z-index:999; left:0; top:0; width:100%; height:100%; background:rgba(0,0,0,0.9); justify-content:center; align-items:center; }
.modal-content { background:#111; padding:20px; border-radius:8px; max-width:900px; width:90%; display:flex; gap:20px; color:#fff; }
.modal img { width:100px; height:200px; object-fit:cover; border-radius:8px; }
.modal-info { flex:1; display:flex; flex-direction:column; justify-content:space-between; }
.buttons { display:flex; gap:15px; }
.buttons button { padding:10px 20px; border:none; border-radius:6px; cursor:pointer; font-size:16px; font-weight:bold;
    tabIndex="0";
}
.btn-volver { background:#666; color:#fff; }
.btn-play { background:#28a745; color:#fff; }

/* Borde de foco para botones */
.buttons button:focus {
    outline: 3px solid yellow; 
    outline-offset: 2px;
}
</style>
</head>
<body>

<div class="slider" id="slider"></div>

<div id="buscador" tabindex="0">
  <input type="text" id="inputBuscar" placeholder="Buscar...">
  <button id="btnBuscar">游댌</button> 
</div>

<div class="categorias" id="categorias"></div>

<div id="modal" class="modal">
  <div class="modal-content">
    <img id="modal-image" src="">
    <div class="modal-info">
      <div>
        <h2 id="modal-title"></h2>
        <p id="modal-desc"></p>
      </div>
      <div class="buttons">
        <button class="btn-volver" onclick="cerrarModal()" tabindex="0">Volver</button>
        <button class="btn-play" onclick="reproducir()" id="btnReproducir" tabindex="0">Reproducir</button>
      </div>
    </div>
  </div>
</div>

<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
<script>
// ====================================================================
// Configuraci칩n de Firebase
// ====================================================================
const firebaseConfig = {
    apiKey: "AIzaSyD6Tj5S2TvV_k8jq0P4ET_Mxo_YgoWtBwo",
    authDomain: "chunito-d25bb.firebaseapp.com",
    databaseURL: "https://chunito-d25bb-default-rtdb.firebaseio.com/",
    projectId: "chunito-d25bb",
    storageBucket: "chunito-d25bb.appspot.com",
    messagingSenderId: "748622352005",
    appId: "1:748622352005:web:f9ea6d2da8af92f76123ec"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

// ====================================================================
// Variables y Elementos DOM
// ====================================================================
const sliderDiv = document.getElementById("slider");
const categoriasDiv = document.getElementById("categorias");
const buscadorDiv = document.getElementById("buscador");
const inputBuscar = document.getElementById("inputBuscar");
const modal = document.getElementById("modal");
const modalImage = document.getElementById("modal-image");
const modalTitle = document.getElementById("modal-title");
const modalDesc = document.getElementById("modal-desc");
const btnReproducir = document.getElementById("btnReproducir");
const btnBuscar = document.getElementById("btnBuscar");

let categoriasArray = [];
let indiceCat = 0;
let currentUrl = "";

// ====================================================================
// Funciones de Interfaz y Modal
// ====================================================================

// Al cargar, enfocamos el contenedor de la lupa
window.onload = () => {
    buscadorDiv.focus();
};

function mostrarCategoria(idx) {
    categoriasArray.forEach(c => c.style.display = 'none'); 

    categoriasArray.forEach((c, i) => { c.classList.toggle("active", i === idx); });
    
    if (categoriasArray[idx]) {
        categoriasArray[idx].style.display = 'block'; 
    }

    const itemsContainer = categoriasArray[idx].querySelector(".items");
    const primerItemVisible = Array.from(itemsContainer.querySelectorAll(".item")).find(item => item.style.display !== 'none');
    
    if (primerItemVisible) {
        primerItemVisible.focus();
        centrarItemEnfocado(primerItemVisible);
    } else {
        buscadorDiv.focus();
    }
}

function abrirModal(item) {
    modalImage.src = item.imagen;
    modalTitle.textContent = item.nombre;
    modalDesc.textContent = item.descripcion || "Sin descripci칩n";
    currentUrl = item.url;
    modal.style.display = "flex";

    setTimeout(() => {
        btnReproducir.focus();
    }, 50);
}

function cerrarModal() {
    modal.style.display = "none";
    
    const itemQueAbrio = document.activeElement;
    if (itemQueAbrio && itemQueAbrio.classList.contains('item') && itemQueAbrio.style.display !== 'none') {
        centrarItemEnfocado(itemQueAbrio);
        itemQueAbrio.focus();
    } else {
        const primerItem = categoriasArray[indiceCat].querySelector(".item:not([style*='display: none'])");
        if(primerItem) primerItem.focus();
        else buscadorDiv.focus();
    }
}

function reproducir() {
    if (currentUrl) window.open(currentUrl, "_blank");
}

function centrarItemEnfocado(item) {
    if (!item) return;

    item.scrollIntoView({
        behavior: 'smooth',
        block: 'nearest',
        inline: 'center'
    });
}

// ====================================================================
// Carga de Datos (Slider y Categor칤as)
// ====================================================================

// Carga de Slider - SOLUCI칍N ESTABLE PARA ROTACI칍N
db.ref("Pingo/sliders").once("value").then(snap => {
    sliderDiv.innerHTML = "";
    const sliders = [];
    snap.forEach(s => {
        if (typeof s.val() === 'string') {
             sliders.push(s.val());
        }
    });

    if (sliders.length > 0) {
        let idx = 0;
        const img = document.createElement("img");
        img.src = sliders[idx];
        sliderDiv.appendChild(img);
        
        // Solo iniciamos el intervalo si hay m치s de un slider
        if (sliders.length > 1) {
            // El slider cambia cada 10 segundos (10000ms)
            setInterval(() => { 
                idx = (idx + 1) % sliders.length; 
                img.src = sliders[idx]; 
            }, 10000); 
        }
    }
}).catch(error => {
    console.error("Error al cargar sliders:", error);
});


// Carga de Categor칤as (usa .on para actualizaci칩n en tiempo real)
db.ref("Ura/categorias").on("value", snap => {
    categoriasDiv.innerHTML = "";
    categoriasArray = [];
    snap.forEach(catSnap => {
        const cat = catSnap.val();
        const catDiv = document.createElement("div");
        catDiv.className = "categoria";
        catDiv.setAttribute('data-category-name', cat.nombre.toLowerCase());
        catDiv.innerHTML = `<h2>${cat.nombre}</h2><div class="items"></div>`;
        const itemsDiv = catDiv.querySelector(".items");

        if (cat.items) {
            // Invertimos el orden para que los nuevos 칤tems aparezcan primero
            Object.entries(cat.items).reverse().forEach(([k, item]) => {
                const itemDiv = document.createElement("div");
                itemDiv.className = "item";
                itemDiv.tabIndex = 0;
                itemDiv.setAttribute('data-name', item.nombre.toLowerCase()); 
                itemDiv.innerHTML = `<img src="${item.imagen}" alt="${item.nombre}"><span>${item.nombre}</span>`;
                itemDiv.onclick = () => abrirModal(item);
                itemsDiv.insertBefore(itemDiv, itemsDiv.firstChild);
            });
        }
        categoriasArray.push(catDiv);
        categoriasDiv.appendChild(catDiv);
    });
    indiceCat = 0;
    mostrarCategoria(indiceCat);
});

// ====================================================================
// L칩gica de B칰squeda en Tiempo Real y Precisi칩n
// ====================================================================

inputBuscar.addEventListener("keyup", () => {
    const term = inputBuscar.value.toLowerCase().trim();
    const allItems = document.querySelectorAll(".item");
    let primerEncontrado = null;

    categoriasArray.forEach(cat => cat.style.display = 'none');

    allItems.forEach(item => {
        const itemName = item.getAttribute('data-name');
        
        const isMatch = term === "" || itemName.startsWith(term) || itemName.includes(term);

        if (isMatch) {
            item.style.display = "flex";
            const parentCat = item.closest('.categoria');
            
            if (!primerEncontrado) {
                parentCat.style.display = 'block'; 
                categoriasArray.forEach(c => c.classList.remove("active"));
                parentCat.classList.add("active");
                indiceCat = categoriasArray.indexOf(parentCat); 
                primerEncontrado = item;
            }
        } else {
            item.style.display = "none";
        }
    });

    if (term !== "" && primerEncontrado) {
        primerEncontrado.focus();
        centrarItemEnfocado(primerEncontrado);
    } else if (term === "") {
        mostrarCategoria(indiceCat);
    }
});


// ====================================================================
// Manejo de Teclado (TV Remote)
// ====================================================================

window.addEventListener("keydown", e => {
    const itemActual = document.activeElement;
    
    // CASO 1: Foco en el CONTENEDOR DE LUPA (navegando o a punto de escribir)
    if (itemActual === buscadorDiv) {
        const isWritingKey = e.key.length === 1 || e.key === 'Backspace' || e.key === 'Delete';

        if (e.key === "ArrowDown" || e.key === "Enter") {
            // Al presionar Abajo o Enter en el contenedor, pasamos el foco al input
            inputBuscar.focus();
            e.preventDefault();
            return;
        } else if (isWritingKey) {
            // Si presionan una tecla de escritura, forzamos el foco al input
            inputBuscar.focus();
            // Dejamos que la tecla se escriba
            return;
        }
    }

    // CASO 2: Foco en el INPUT (Escribiendo)
    if (itemActual === inputBuscar) {
        if (e.key === "ArrowDown" || e.key === "Enter") {
            // Al presionar Abajo o Enter, ir al primer resultado o 칤tem
            const primerVisible = document.querySelector(".categoria.active .item:not([style*='display: none'])");
            if (primerVisible) {
                primerVisible.focus();
                centrarItemEnfocado(primerVisible);
            }
            e.preventDefault();
            return;
        }
        // Las dem치s teclas de escritura (letras, etc.) se gestionan por defecto en el input
        return;
    }
    
    // Manejo de foco en el modal
    if (modal.style.display === "flex") {
        if (e.key === "Escape") {
            cerrarModal();
            e.preventDefault();
        }
        return; 
    }

    // ESCAPE: Limpia la b칰squeda y vuelve a enfocar el contenedor de la lupa
    if (e.key === "Escape") {
        inputBuscar.value = "";
        document.querySelectorAll(".item").forEach(item => item.style.display = "flex");
        mostrarCategoria(0);
        buscadorDiv.focus();
        e.preventDefault();
    }
    // Flecha Abajo (Navegaci칩n vertical)
    else if (e.key === "ArrowDown") {
        if (indiceCat < categoriasArray.length - 1) {
             indiceCat++; 
             mostrarCategoria(indiceCat); 
             e.preventDefault();
        }
    } 
    // Flecha Arriba (Navegaci칩n vertical)
    else if (e.key === "ArrowUp") {
        if (indiceCat > 0) {
             indiceCat--;
             mostrarCategoria(indiceCat); 
             e.preventDefault();
        }
        // Si est치 en la primera categor칤a y presiona UP, enfoca el contenedor de la lupa
        else if(indiceCat === 0){
            buscadorDiv.focus();
            e.preventDefault();
        }
    }
    // Flecha Derecha/Izquierda (Desplazamiento horizontal de items)
    else if (e.key === "ArrowRight" || e.key === "ArrowLeft") {
        if (itemActual && itemActual.classList.contains('item')) {
            let nuevoFoco = null;
            let nextElement = (e.key === "ArrowRight") ? itemActual.nextElementSibling : itemActual.previousElementSibling;

            while(nextElement){
                if(nextElement.style.display !== 'none'){
                    nuevoFoco = nextElement;
                    break;
                }
                nextElement = (e.key === "ArrowRight") ? nextElement.nextElementSibling : nextElement.previousElementSibling;
            }
            
            if (nuevoFoco) {
                nuevoFoco.focus();
                centrarItemEnfocado(nuevoFoco);
                e.preventDefault();
            } else {
                e.preventDefault();
            }
        }
    }
    // ENTER/ESPACIO para abrir el modal
    else if (e.key === "Enter" || e.key === " "){
        if(itemActual && itemActual.classList.contains('item')){
            itemActual.click();
            e.preventDefault();
        }
    }
});
</script>
</body>
</html>
