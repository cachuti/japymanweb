<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0"> 
    <title>Box Zone TV - Men√∫ Lateral HBO Max</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <style>
        /* ---------------------------------------------------- */
        /* --------- BASE Y LAYOUT (HORIZONTAL FLEX) -------- */
        /* ---------------------------------------------------- */
        html, body { 
            margin:0; padding:0; background:#000; color:#fff; 
            font-family:Arial, sans-serif; 
            height: 100%; width: 100%;
            overflow: hidden; 
        }
        
        #main-container {
            display: flex;
            height: 100%;
            width: 100%;
        }

        /* ---------------------------------------------------- */
        /* --------- BARRA LATERAL (MENU - HBO MAX STYLE) ----- */
        /* ---------------------------------------------------- */
        #sidebar {
            width: 80px; 
            height: 100%;
            background: #000;
            padding-top: 150px; 
            display: flex;
            flex-direction: column;
            align-items: center;
            flex-shrink: 0;
            z-index: 30; /* Debe estar sobre el contenido principal */
            box-shadow: 2px 0 5px rgba(0, 0, 0, 0.5);
        }

        .menu-item {
            font-size: 1.1em;
            padding: 15px 0;
            width: 100%;
            text-align: center;
            transition: all 0.2s;
            cursor: pointer;
            border-left: 5px solid transparent;
            color: #999; 
            /* Se usa el nombre de la categor√≠a, por ahora es solo el √≠ndice */
            line-height: 1.2; 
        }

        /* Foco Estilo HBO Max (Azul) */
        .menu-item.focused {
            color: #fff;
            font-weight: bold;
            border-left: 5px solid #005ce6; 
            background: rgba(0, 92, 230, 0.2); 
            transform: scale(1.05);
        }

        /* ---------------------------------------------------- */
        /* --------- CONTENIDO PRINCIPAL (Slider + Fila) ------ */
        /* ---------------------------------------------------- */
        #content-wrapper {
            flex-grow: 1; /* Ocupa el resto del espacio horizontal */
            display: flex;
            flex-direction: column; 
            position: relative;
            height: 100%;
        }

        /* ---------------------------------------------------- */
        /* --------- SLIDER / DESTACADO ----------------------- */
        /* ---------------------------------------------------- */
        .slider { 
            width:100%; 
            height: 330px; 
            position:relative; 
            background:#111; 
            overflow: hidden; 
            flex-shrink: 0; 
            z-index: 10; 
        }
        .slider img { 
            width:100%; height:100%; object-fit:cover; position:absolute; top:0; left:0; 
            opacity:0; pointer-events:none; 
            transition: opacity 1s ease-in-out; 
        }
        .slider img.active { 
            opacity:1; 
        }

        /* ---------------------------------------------------- */
        /* --------- B√öSQUEDA Y LUPA -------------------------- */
        /* ---------------------------------------------------- */
        .header { 
            position:absolute; top:20px; right:30px; font-size:24px; cursor:pointer; 
            z-index: 200; 
            padding: 8px; border-radius: 8px;
            transition: all 0.2s ease;
        }
        .header.focused { 
            border:2px solid #005ce6; /* Foco azul */
            transform: scale(1.1);
            background: rgba(0, 92, 230, 0.2);
        }
        .search-box { 
            display:none; position:absolute; top:70px; right:30px; z-index:200; 
            background: rgba(0,0,0,0.8); padding:15px; border-radius:10px;
        }
        .search-box input { 
            padding:12px; font-size:18px; border-radius:6px; border:none; 
            background:#333; color:#fff; width: 300px;
        }

        /* ---------------------------------------------------- */
        /* --------- CONTENEDOR DE CATEGOR√çAS ----------------- */
        /* ---------------------------------------------------- */
        #categories {
            flex-grow: 1; 
            overflow-y: hidden; 
            position: relative; 
            
            /* SUPERPOSICI√ìN */
            margin-top: -100px; 
            padding-top: 100px; 
            padding-bottom: 20px; 
            
            scrollbar-width: none; 
            z-index: 20; 
        }
        #categories::-webkit-scrollbar { display: none; }

        /* Estilos de Categor√≠a e √çtems */
        .category { 
            text-align:left; 
            padding:10px 0 10px 20px; 
        } 
        .category h2 { 
            margin:0 0 10px 0; 
            font-size: 1.4em; 
        }
        .items { 
            display:flex; 
            overflow-x: auto; 
            padding-bottom: 10px; 
            scrollbar-width: none; 
            position: relative; 
            z-index: 50; 
        } 
        .items::-webkit-scrollbar { 
            display: none; 
        }
        .item { 
            width:150px; 
            height:220px; 
            margin:0 8px; 
            background:#333; border-radius:6px; 
            display:flex; align-items:center; justify-content:center; flex-shrink:0; 
            transition:transform 0.2s, box-shadow 0.2s; cursor:pointer;
            position: relative;
        }
        .item img { width:100%; height:100%; object-fit:cover; border-radius:6px; }
        .item.focused { 
            transform:scale(1.25); 
            border:3px solid #005ce6; /* Foco azul */
            box-shadow: 0 0 10px rgba(0, 92, 230, 0.5);
            z-index: 60; 
        }
        
        /* ---------------------------------------------------- */
        /* --------- MODAL (Detalles de Pel√≠cula) ------------- */
        /* ---------------------------------------------------- */
        .modal { 
            display:none; position:fixed; top:0; left:0; width:100%; height:100%; 
            background:rgba(0,0,0,0.9); justify-content:center; align-items:center; z-index:1000; 
        }
        .modal-content { 
            background:#1a1a1a; padding:30px; border-radius:10px; 
            max-width:70%; display:flex; gap: 30px; 
            box-shadow: 0 5px 20px rgba(0,0,0,0.5);
        } 
        .modal-image-container { flex-shrink: 0; }
        .modal-image-container img { width:200px; height:300px; object-fit:cover; border-radius:6px; }
        .modal-details { text-align: left; }
        .modal h2 { margin-top:0; font-size: 2em; }
        .modal p { color:#ccc; }
        
        .modal-buttons { margin-top:20px; display: flex; gap: 15px; }
        .modal-buttons button { 
            padding:12px 25px; border:none; border-radius:4px; cursor:pointer; 
            font-size:1.1em; transition: transform 0.2s;
        }
        .modal-buttons .play { background:#005ce6; color:#fff; } /* Bot√≥n principal azul */
        .modal-buttons .back { background:#555; color:#fff; }
        .modal-buttons button.focused-modal { border:3px solid yellow; transform: scale(1.05); }
    </style>
</head>
<body>
    
    <div id="main-container">
        <div id="sidebar">
            <div id="sidebar-search-placeholder" class="menu-item">üîç</div>
            </div>

        <div id="content-wrapper">
            <div class="slider" id="slider"></div> 
            <div class="header" id="searchBtn" style="display: none;"></div>
            <div class="search-box" id="searchBox">
                <input type="text" id="searchInput" placeholder="Buscar por t√≠tulo...">
            </div>
            <div id="categories"></div>
        </div>
    </div>

    <div class="modal" id="modal">
        <div class="modal-content">
            <div class="modal-image-container">
                <img id="modalImg" src="">
            </div>
            <div class="modal-details">
                <h2 id="modalTitle"></h2>
                <p id="modalDesc"></p>
                <div class="modal-buttons">
                    <button class="play" id="modalPlayBtn">Reproducir</button>
                    <button class="back" id="modalBackBtn">Atr√°s</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Inicializaci√≥n de Firebase (NO CAMBIA)
        const firebaseConfig = {
            apiKey: "AIzaSyD6Tj5S2TvV_k8jq0P4ET_Mxo_YgoWtBwo",
            authDomain: "chunito-d25bb.firebaseapp.com",
            databaseURL: "https://chunito-d25bb-default-rtdb.firebaseio.com",
            projectId: "chunito-d25bb",
            storageBucket: "chunito-d25bb.firebasestorage.app",
            messagingSenderId: "748622352005",
            appId: "1:748622352005:web:f9ea6d2da8af92f76123ec",
            measurementId: "G-DC3XNLCX9Z"
        };
        firebase.initializeApp(firebaseConfig);
        
        const dbRef = firebase.database().ref("piedra"); 
        const sliderRef = firebase.database().ref("config/slider"); 

        // Variables de Estado
        let categories = [], activeCategoryIndex = 0, activeItemIndex = 0;
        let currentData = {}, allMovies = []; 
        let focusArea = 'menu'; // üõë CAMBIO: El foco inicial es el men√∫
        let activeModalButton = 0; 
        let searchResults = null; 
        let isSearchBoxOpen = false;
        let sliderImages = [];
        let currentSliderIndex = 0;
        let searchMenuIndex = -1; // √çndice especial para el bot√≥n de b√∫squeda

        // Variables DOM globales 
        let categoriesDiv, sliderDiv, searchBtn, searchBox, searchInput, modal, modalButtons, sidebarDiv, searchPlaceholder;

        // --- Carga de Datos y Inicializaci√≥n ---
        function loadData() {
            dbRef.orderByChild('timestamp').on("value", snap => {
                const data = snap.val();
                currentData = {}; allMovies = [];

                if (data) {
                    const moviesArray = Object.keys(data).map(key => ({ key, ...data[key] })).reverse();
                    
                    moviesArray.forEach(m => {
                        allMovies.push(m);
                        if (!currentData[m.category]) currentData[m.category] = [];
                        currentData[m.category].push(m);
                    });
                    categories = Object.keys(currentData);
                    renderSidebar(); // üõë Nuevo: Renderiza el men√∫ despu√©s de cargar categor√≠as
                }
                if (focusArea !== 'modal') {
                    setFocus('menu'); 
                }
            });

            sliderRef.once('value', snap => {
                const sliderUrls = snap.val() || ["https://via.placeholder.com/1920x330/888/fff?text=Pelicula+Destacada"];
                sliderDiv.innerHTML = "";
                
                sliderImages = sliderUrls.map((url, index) => {
                    const img = document.createElement("img"); 
                    img.src = url; 
                    if (index === 0) {
                        img.classList.add('active'); 
                    }
                    sliderDiv.appendChild(img);
                    return img;
                });
                startSliderRotation();
            });
        }
        
        // --- Renderizado del Men√∫ Lateral ---
        function renderSidebar() {
            sidebarDiv.innerHTML = "";
            const totalItems = categories.length + 1; // +1 para la b√∫squeda
            
            // 1. Renderizar el bot√≥n de b√∫squeda
            searchPlaceholder.onclick = () => { setFocus('search'); };
            sidebarDiv.appendChild(searchPlaceholder);
            
            // 2. Renderizar las categor√≠as
            categories.forEach((name, index) => {
                const item = document.createElement("div");
                item.classList.add("menu-item");
                item.innerText = name;
                item.dataset.index = index;
                item.onclick = () => { 
                    activeCategoryIndex = index;
                    activeItemIndex = 0;
                    setFocus('items'); 
                };
                sidebarDiv.appendChild(item);
            });
        }

        // --- Manejo de Foco ---
        function setFocus(area) {
            document.querySelectorAll('.focused, .focused-modal').forEach(el => el.classList.remove('focused', 'focused-modal'));
            
            focusArea = area;
            searchBox.style.display = "none";
            searchInput.blur();
            isSearchBoxOpen = false;

            // Define qu√© est√° enfocado para el renderizado
            if (area === 'menu' || area === 'search') {
                let target = (activeCategoryIndex === searchMenuIndex) ? searchPlaceholder : sidebarDiv.querySelector(`[data-index="${activeCategoryIndex}"]`);
                if (target) {
                    target.classList.add("focused");
                    target.scrollIntoView({ block: 'nearest', behavior: 'smooth' });
                }
                if (area === 'search') {
                    openSearchInput();
                }
                // Al volver al men√∫, siempre renderiza la categor√≠a activa (vista √∫nica)
                renderCategory(); 
            } else if (area === 'items') {
                // Al entrar a los items, activa la categor√≠a correspondiente en el men√∫ como "seleccionada" (pero no "focused")
                const selectedMenu = sidebarDiv.querySelector(`[data-index="${activeCategoryIndex}"]`);
                if(selectedMenu) selectedMenu.classList.add("focused");
                renderCategory(searchResults); 
            } else if (area === 'modal') {
                modal.style.display = 'flex';
                focusModalButton(0);
            }
        }

        function openSearchInput() {
            if (!isSearchBoxOpen) {
                isSearchBoxOpen = true;
                searchBox.style.display = "block";
                searchInput.focus();
            }
        }

        function focusModalButton(index) {
            modalButtons.forEach(btn => btn.classList.remove("focused-modal"));
            activeModalButton = index;
            if (modalButtons[index]) modalButtons[index].classList.add("focused-modal");
        }
        
        // --- Renderizado de Categor√≠a √önica (NO CAMBIA) ---
        function renderCategory(filteredData = null) {
            if (!categoriesDiv) return; 
            
            categoriesDiv.innerHTML = "";
            
            let dataToRender = null;
            let catName = "Contenido";

            if (filteredData) {
                // Modo B√∫squeda
                dataToRender = filteredData;
                catName = `Resultados para "${searchInput.value}"`;
            } else if (categories.length > 0) {
                // Modo Categor√≠a √önica (Usa activeCategoryIndex)
                const currentCategoryName = categories[activeCategoryIndex];
                dataToRender = currentData[currentCategoryName];
                catName = currentCategoryName;
            }

            if (!dataToRender || dataToRender.length === 0) {
                 categoriesDiv.innerHTML = `<div class="category"><h2>${catName}: No hay contenido.</h2></div>`;
                 return;
            }

            // Renderiza la categor√≠a activa (o resultados)
            const section = document.createElement("div");
            section.classList.add("category");
            section.innerHTML = `<h2>${catName}</h2>`;
            const itemsContainer = document.createElement("div"); 
            itemsContainer.classList.add("items");
            
            dataToRender.forEach((m, itemIndex) => {
                const isFocused = focusArea === 'items' && itemIndex === activeItemIndex;
                const item = createItemElement(m, itemIndex, isFocused);
                item.addEventListener('click', () => {
                     activeItemIndex = itemIndex; 
                     openModal(m, filteredData !== null); 
                });
                itemsContainer.appendChild(item);
            });
            section.appendChild(itemsContainer); 
            categoriesDiv.appendChild(section);

            // Control de scroll y foco
            if (focusArea === 'items') {
                const focusedElement = document.querySelector(".item.focused");
                if (focusedElement) {
                    focusedElement.scrollIntoView({ 
                        behavior: 'smooth', 
                        inline: 'center', 
                        block: 'nearest' 
                    });
                }
            }
        }

        function createItemElement(movie, index, isFocused) {
            const item = document.createElement("div");
            item.classList.add("item");
            if (isFocused) { item.classList.add("focused"); }
            
            const img = document.createElement("img"); img.src = movie.image; item.appendChild(img);
            item.dataset.index = index; item.dataset.title = movie.title;
            return item;
        }

        function closeModal() { 
            modal.style.display = "none";
            // Vuelve al foco del men√∫ si estaba en el men√∫ o b√∫squeda, o a los items si estaba all√≠.
            if (searchResults) {
                setFocus('items'); 
            } else if (focusArea === 'modal') { // Siempre volvemos al men√∫ si salimos del modal.
                 setFocus('menu'); 
            }
        }
        
        function handleSearchInput(term) {
            const normalizedTerm = term.toLowerCase().trim();
            
            if (normalizedTerm === "") {
                searchResults = null;
                // Si borra la b√∫squeda, vuelve al foco normal del men√∫
                activeCategoryIndex = 0; activeItemIndex = 0;
                setFocus('menu'); 
            } else {
                const filtered = allMovies.filter(m => m.title.toLowerCase().includes(normalizedTerm));
                searchResults = filtered;
                activeCategoryIndex = searchMenuIndex; // Foco l√≥gico en la "categor√≠a" de b√∫squeda
                activeItemIndex = 0;
                setFocus('items'); 
            }
        }


        // --- L√≥gica de Teclado (Navegaci√≥n) ---
        document.addEventListener("keydown", e => {
            const key = e.key;

            if (focusArea === 'modal') {
                // (No cambia)
                const currentButtons = modal.querySelectorAll('.modal-buttons button');
                if (key === "ArrowRight") { if (activeModalButton < currentButtons.length - 1) focusModalButton(activeModalButton + 1); } 
                else if (key === "ArrowLeft") { if (activeModalButton > 0) focusModalButton(activeModalButton - 1); } 
                else if (key === "Enter") {
                    if (currentButtons[activeModalButton] === document.getElementById("modalPlayBtn")) { playMovie(); } 
                    else { closeModal(); }
                } else if (key === "Escape") { closeModal(); } 
                return; 
            }

            if (focusArea === 'menu' || focusArea === 'search') {
                const totalCategories = categories.length;
                
                if (key === "ArrowUp") {
                    if (activeCategoryIndex > searchMenuIndex) { 
                        activeCategoryIndex--; 
                    }
                } else if (key === "ArrowDown") {
                    if (activeCategoryIndex < totalCategories - 1) { 
                        activeCategoryIndex++; 
                    }
                } else if (key === "ArrowRight" || key === "Enter") {
                    if (activeCategoryIndex === searchMenuIndex) {
                        setFocus('search');
                    } else if (categories.length > 0) {
                        // Ir a los √≠tems de la categor√≠a seleccionada
                        activeItemIndex = 0;
                        searchResults = null;
                        setFocus('items');
                    }
                }
                
                // Si el foco estaba en el men√∫ o b√∫squeda, actualiza la visualizaci√≥n
                if (key === "ArrowUp" || key === "ArrowDown" || key === "ArrowRight") {
                    setFocus('menu'); // Vuelve a renderizar para aplicar el foco del men√∫
                }
                return;
            }
            
            if (focusArea === 'items') {
                const dataSet = searchResults || (categories.length > 0 ? currentData[categories[activeCategoryIndex]] : null);
                
                if (!dataSet || dataSet.length === 0) {
                     if (key === "ArrowLeft") setFocus('menu');
                     return; 
                }

                if (key === "ArrowRight") {
                    if (activeItemIndex < dataSet.length - 1) { activeItemIndex++; setFocus('items'); }
                } else if (key === "ArrowLeft") {
                    if (activeItemIndex > 0) { activeItemIndex--; setFocus('items'); }
                    else {
                        // üõë CLAVE: Vuelve al men√∫ lateral al llegar al primer √≠tem
                        setFocus('menu');
                        // Asegura que el foco del men√∫ permanezca en la categor√≠a actual
                    }
                } else if (key === "ArrowDown" || key === "ArrowUp") { 
                    // üõë CLAVE: En la vista √∫nica, las flechas verticales no hacen nada en la fila
                } else if (key === "Enter") {
                    const movie = dataSet[activeItemIndex]; 
                    openModal(movie, searchResults !== null);
                }
            }
        });

        // --- Inicializaci√≥n DOM ---
        document.addEventListener('DOMContentLoaded', () => {
            categoriesDiv = document.getElementById("categories");
            sliderDiv = document.getElementById("slider");
            sidebarDiv = document.getElementById("sidebar"); // Nuevo
            searchPlaceholder = document.getElementById("sidebar-search-placeholder"); // Nuevo
            searchBox = document.getElementById("searchBox");
            searchInput = document.getElementById("searchInput");
            modal = document.getElementById("modal");
            
            // üõë Calcula el √≠ndice de la b√∫squeda (antes de la categor√≠a 0)
            searchMenuIndex = -1; 
            
            document.getElementById("modalBackBtn").onclick = closeModal;
            document.getElementById("modalPlayBtn").onclick = playMovie;
            searchInput.addEventListener("input", e => { handleSearchInput(e.target.value); });
            
            loadData();
        });
        
        // La funci√≥n playMovie no necesita cambios ya que usa activeCategoryIndex y activeItemIndex.
        function playMovie() { 
            let movie;
            const isSearch = searchResults !== null;
            
            if (isSearch) {
                movie = searchResults[activeItemIndex];
            } else {
                const categoryName = categories[activeCategoryIndex];
                movie = currentData[categoryName] ? currentData[categoryName][activeItemIndex] : null;
            }

            if (movie && movie.link) {
                console.log("Reproduciendo:", movie.link);
                // Aqu√≠ ir√≠a la llamada a tu reproductor de video (ej: window.location.href = movie.link;)
                alert(`Reproduciendo: ${movie.title}\nEnlace: ${movie.link}`);
            } else {
                alert("ERROR: No se encontr√≥ el enlace de la pel√≠cula.");
            }
            closeModal();
        }

        // SLIDER (Rotaci√≥n) - (No cambia)
        function startSliderRotation() {
            if (window.sliderInterval) clearInterval(window.sliderInterval); 
            if (sliderImages.length > 1) {
                window.sliderInterval = setInterval(rotateSlider, 8000); 
            } else if (sliderImages.length === 1) {
                sliderImages[0].classList.add('active'); 
            }
        }

        function rotateSlider() {
            if (sliderImages.length === 0) return;
            sliderImages[currentSliderIndex].classList.remove('active');
            currentSliderIndex = (currentSliderIndex + 1) % sliderImages.length;
            sliderImages[currentSliderIndex].classList.add('active');
        }

    </script>
</body>
</html>
