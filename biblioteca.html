<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8" />
    <title>Box Zone Film</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --color-bg-dark: #1a001f;
            --color-bg-light: #2a0033;
            --color-text-light: #f5f5f5;
            --color-text-dim: #bbb;
            --color-focus-glow: #a020f0;
        }
        html,body { height:100%; }
        body {
            background: linear-gradient(180deg, #2a0033 0%, #1a001f 100%);
            color: var(--color-text-light);
            font-family: 'Poppins', sans-serif;
            margin: 0;
            padding: 0;
            overflow-x: hidden;
        }

        /* ---------- HEADER (mantiene el espacio del título para no romper layout) ---------- */
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 4%;
            position: sticky;
            top: 0;
            z-index: 60; /* sobre el slider */
            background: rgba(42, 0, 51, 0.9);
            backdrop-filter: blur(5px);
            border-bottom: 1px solid rgba(224, 195, 255, 0.06);
            height: 64px;
            box-sizing: border-box;
        }
        /* título EXISTE en DOM (mantiene espacio) pero NO se ve */
        #main-title { visibility: hidden; margin: 0; font-size: 2.2rem; }

        .search-container {
            display: flex;
            align-items: center;
            position: relative;
        }

        /* input oculto por defecto; al abrir (clase active) se muestra */
        #search-input {
            width: 0;
            padding: 0;
            border: none;
            background: transparent;
            color: var(--color-text-light);
            font-size: 1.05rem;
            transition: width 0.25s ease, padding 0.25s ease;
            cursor: pointer;
        }
        #search-input.active {
            width: 280px;
            padding: 8px 12px;
            background: var(--color-bg-light);
            border-radius: 18px;
            cursor: text;
        }
        #search-input:focus { outline: none; box-shadow: 0 0 0 3px rgba(160,32,240,0.12); }

        .search-button {
            background: transparent;
            border: none;
            color: var(--color-text-light);
            font-size: 1.4rem;
            cursor: pointer;
            padding: 8px;
        }
        .search-button:focus { outline: none; transform: scale(1.04); color: var(--color-focus-glow); }

        /* ---------- SLIDER DECORATIVO (300px) ---------- */
        #decor-slider {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 300px; /* <-- AUMENTADO a 300px (request) */
            overflow: hidden;
            z-index: 10; /* detrás del header */
            pointer-events: none;
            user-select: none;
            background: linear-gradient(180deg, rgba(0,0,0,0.12), rgba(0,0,0,0.18));
        }
        #decor-slider .slide {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
            opacity: 0;
            transition: opacity 1s ease;
        }
        #decor-slider .slide.active { opacity: 1; }

        /* ---------- MAIN / CONTENIDO - siempre estático ---------- */
        .main-container {
            padding: 0 4%;
            position: relative;
            z-index: 20; /* contenido encima del slider */
            box-sizing: border-box;
            /* padding-top ajustado dinámicamente por JS para que quede en la posición correcta */
        }

        .section-title {
            font-size: 1.6rem;
            font-weight: 700;
            color: #e0c3ff;
            margin: 1.8rem 0 0.8rem;
        }

        .carousel {
            display: flex;
            gap: 1rem;
            padding: 0.8rem 0 1.6rem;
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
        }
        .carousel::-webkit-scrollbar { height: 8px; }
        .carousel::-webkit-scrollbar-thumb { background: var(--color-bg-light); border-radius: 10px; }

        .item-card {
            flex-shrink: 0;
            width: 140px;
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
            cursor: pointer;
            transition: transform 0.18s ease;
            outline: none;
        }
        .item-card .item {
            width: 140px; height: 190px;
            border-radius: 12px; overflow: hidden; background:#000;
            box-shadow: 0 0 12px rgba(0,0,0,0.6);
        }
        .item-card img { width:100%; height:100%; object-fit:cover; display:block; }

        .item-title { margin-top: 0.5rem; font-size: 0.9rem; color:var(--color-text-light); }

        .item-card:focus { transform: scale(1.06); }
        /* BUSQUEDA: atenuar no-matches sin remover DOM (NO mueve layout) */
        .item-card.dim { opacity: 0.28; filter: grayscale(0.8); pointer-events: none; }
        .item-card.match { box-shadow: 0 0 18px rgba(160,32,240,0.45); }

        /* modal (sin tocar) */
        .modal { position: fixed; top:0; left:0; width:100%; height:100%; display:none; align-items:center; justify-content:center; z-index:100; background: rgba(10,0,20,0.95); }
        .modal.active { display:flex; }
        .modal-content { background:#2a0033; padding:2rem; border-radius:18px; color:#fff; max-width:900px; width:90%; display:flex; gap:1.5rem; box-shadow: 0 0 30px rgba(160,32,240,0.6); }
        .modal-image{ width:200px; height:300px; object-fit:cover; border-radius:10px; }
        .modal-details h3{ margin:0; color:#d9b3ff; font-size:2rem; }
        .modal-details p{ color:var(--color-text-dim); max-height:260px; overflow:auto; }
        .modal-actions{ margin-top:1rem; display:flex; gap:8px; }
        .modal-button{ padding:10px 16px; border-radius:8px; border:none; cursor:pointer; }
        .modal-button.play{ background:var(--color-focus-glow); color:#fff; }
        .modal-button.back{ background:#5a2d82; color:#fff; }
    </style>
</head>
<body>
    <!-- HEADER: mantengo el elemento del título (oculto) para preservar layout -->
    <div class="header">
        <h1 id="main-title">Box Zone Film</h1>
        <div class="search-container">
            <input type="text" id="search-input" placeholder="Buscar..." tabindex="-1" />
            <button id="search-button" class="search-button" tabindex="0" aria-label="Buscar">
                <i class="fa-solid fa-magnifying-glass"></i>
            </button>
        </div>
    </div>

    <!-- SLIDER decorativo -->
    <div id="decor-slider" aria-hidden="true"></div>

    <div class="main-container">
        <div id="content-container"></div>
    </div>

    <!-- Modal (igual que antes) -->
    <div id="modal-pelicula" class="modal" aria-hidden="true">
        <div class="modal-content">
            <img id="modal-imagen" class="modal-image" src="" alt="Imagen">
            <div class="modal-details">
                <h3 id="modal-titulo"></h3>
                <p id="modal-descripcion"></p>
                <div class="modal-actions">
                    <a id="btn-reproducir" class="modal-button play" href="#" target="_blank">▶ Reproducir</a>
                    <button id="btn-volver" class="modal-button back">Volver</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <script>
    // ---------- Firebase (sin cambiar nodos: uso exactamente "tuyo" para contenido) ----------
    var firebaseConfig = {
        apiKey: "AIzaSyD6Tj5S2TvV_k8jq0P4ET_Mxo_YgoWtBwo",
        authDomain: "chunito-d25bb.firebaseapp.com",
        projectId: "chunito-d25bb",
        databaseURL: "https://chunito-d25bb-default-rtdb.firebaseio.com",
        storageBucket: "chunito-d25bb.appspot.com",
        messagingSenderId: "748622352005",
        appId: "1:748622352005:web:f9ea6d2da8af92f76123ec"
    };
    firebase.initializeApp(firebaseConfig);
    var db = firebase.database();

    // **Contenido principal**: TU nodo original (no lo cambié)
    var ref = db.ref("tuyo");

    // **Slider**: intento leer "slider" SOLO si existe; si no, placeholders (no crea nada)
    var sliderRef = db.ref("slider");

    // ---------- DOM refs ----------
    var decorSliderElem = document.getElementById('decor-slider');
    var contentContainer = document.getElementById('content-container');
    var searchInput = document.getElementById('search-input');
    var searchButton = document.getElementById('search-button');
    var modal = document.getElementById('modal-pelicula');
    var btnReproducir = document.getElementById('btn-reproducir');
    var btnVolver = document.getElementById('btn-volver');

    // ---------- state ----------
    var sliderSlides = [];
    var sliderCurrent = 0;
    var sliderInterval = null;
    var SLIDER_HEIGHT = 300; // <-- solicitado: 300px
    var allItems = []; // array de arrays [categoriaIndex][itemIndex] => elemento DOM .item-card
    var allCategories = []; // datos
    var lastFocusedElement = null;

    // Ajusta padding-top del main para que quede debajo del slider (y mantenga parte visible)
    function adjustLayoutForSlider(){
        if(decorSliderElem) decorSliderElem.style.top = '0px';
        var headerElem = document.querySelector('.header');
        var headerH = headerElem ? headerElem.offsetHeight : 0;
        var mainCont = document.querySelector('.main-container');
        if(mainCont){
            // hacemos que el contenido arranque con un offset basado en el slider
            var overlayOffset = Math.max(200, SLIDER_HEIGHT - 100); // mantiene buena separación
            mainCont.style.paddingTop = (headerH + overlayOffset) + 'px';
        }
    }

    // ---------- Slider init (lee slider node si existe) ----------
    sliderRef.once("value", function(snapshot){
        sliderSlides = [];
        decorSliderElem.innerHTML = '';
        var count = 0;
        if(snapshot.exists()){
            snapshot.forEach(function(childSnap){
                if(count < 3){
                    var data = childSnap.val();
                    var url = (data && data.url) ? data.url : (typeof data === 'string' ? data : '');
                    if(url){
                        var img = document.createElement('img');
                        img.className = 'slide';
                        img.src = url;
                        img.alt = '';
                        img.setAttribute('draggable','false');
                        decorSliderElem.appendChild(img);
                        sliderSlides.push(img);
                        count++;
                    }
                }
            });
        }
        // si no hay imágenes en BD, usar placeholders (no crea nodos)
        if(sliderSlides.length === 0){
            var defaults = [
                'https://picsum.photos/1600/300?random=1',
                'https://picsum.photos/1600/300?random=2',
                'https://picsum.photos/1600/300?random=3'
            ];
            defaults.forEach(function(u){
                var img = document.createElement('img');
                img.className = 'slide';
                img.src = u;
                img.alt = '';
                img.setAttribute('draggable','false');
                decorSliderElem.appendChild(img);
                sliderSlides.push(img);
            });
        }
        // activar primera y arrancar intervalo
        sliderSlides.forEach(s => s.classList.remove('active'));
        sliderCurrent = 0;
        sliderSlides[0].classList.add('active');
        if(sliderInterval) clearInterval(sliderInterval);
        if(sliderSlides.length > 1){
            sliderInterval = setInterval(function(){
                sliderSlides[sliderCurrent].classList.remove('active');
                sliderCurrent = (sliderCurrent + 1) % sliderSlides.length;
                sliderSlides[sliderCurrent].classList.add('active');
            }, 10000);
        }
        adjustLayoutForSlider();
    });

    // ---------- Render contenido (NO ocultamos categorías: todas están visibles) ----------
    function renderContent(data) {
        contentContainer.innerHTML = "";
        allItems = [];
        allCategories = data || [];

        data.forEach(category => {
            // título
            let sectionTitle = document.createElement('h2');
            sectionTitle.className = "section-title";
            sectionTitle.textContent = category.subtitulo || category.title || "Categoría";
            contentContainer.appendChild(sectionTitle);

            // carrusel
            let carousel = document.createElement('div');
            carousel.className = "carousel";
            contentContainer.appendChild(carousel);

            let rowItems = [];
            // category.items expected as array in earlier versions; handle both structures
            if (Array.isArray(category.items)) {
                category.items.forEach(item => {
                    const card = createItemCard(item);
                    carousel.appendChild(card);
                    rowItems.push(card);
                });
            } else {
                // fallback: if object with keys (older DB shape), iterate keys except 'subtitulo'
                Object.keys(category).forEach(k => {
                    if (k === "subtitulo" || k === "title" || k === "items") return;
                    const item = category[k];
                    if (item && item.titulo) {
                        const card = createItemCard(item);
                        carousel.appendChild(card);
                        rowItems.push(card);
                    }
                });
            }

            allItems.push(rowItems);
        });

        // foco inicial: la lupa (como pediste)
        setTimeout(() => searchButton.focus(), 200);
    }

    // helper: crea la card DOM y setea atributos usados por la búsqueda/modal
    function createItemCard(item){
        const itemCard = document.createElement('div');
        itemCard.className = 'item-card';
        itemCard.setAttribute('tabindex','0');
        itemCard.setAttribute('data-titulo', item.titulo || '');
        itemCard.setAttribute('data-descripcion', item.descripcion || '');
        itemCard.setAttribute('data-imagen', item.imagen || '');
        itemCard.setAttribute('data-url', item.url || '');
        itemCard.innerHTML = `
            <div class="item"><img src="${item.imagen || ''}" alt="${item.titulo || ''}" loading="lazy"></div>
            <span class="item-title">${item.titulo || ''}</span>
        `;
        return itemCard;
    }

    // ---------- BÚSQUEDA (solo al Enter) ----------
    function performSearch(query){
        query = (query||'').toLowerCase().trim();
        // si vacío -> limpiar
        if(!query){
            clearSearchHighlight();
            return;
        }
        // marcar matches y atenuar no-matches (sin remover DOM)
        document.querySelectorAll('.item-card').forEach(card => {
            const t = (card.getAttribute('data-titulo')||'').toLowerCase();
            if(t.includes(query)){
                card.classList.remove('dim');
                card.classList.add('match');
            } else {
                card.classList.add('dim');
                card.classList.remove('match');
            }
        });
        // focus al primer match automáticamente (si existiera)
        const firstMatch = document.querySelector('.item-card.match');
        if(firstMatch) { firstMatch.focus(); lastFocusedElement = firstMatch; }
    }
    function clearSearchHighlight(){
        document.querySelectorAll('.item-card').forEach(card => {
            card.classList.remove('dim','match');
        });
    }

    // ---------- Firebase: cargar categorías desde TU nodo ("tuyo") ----------
    ref.on("value", function(snapshot){
        const categoriesData = [];
        snapshot.forEach(function(categorySnapshot){
            // supongo el mismo shape que tenías: subtitulo + items(->childs)
            const catVal = categorySnapshot.val();
            const category = { subtitulo: catVal.subtitulo || categorySnapshot.key, items: [] };
            categorySnapshot.forEach(function(itemSnapshot){
                if(itemSnapshot.key !== "subtitulo"){
                    category.items.push(itemSnapshot.val());
                }
            });
            if(category.items.length > 0) categoriesData.push(category);
        });
        // guardo para uso
        allCategories = categoriesData;
        renderContent(allCategories);
    });

    // ---------- Modal (igual comportamiento original) ----------
    function openModal(itemData){
        document.getElementById("modal-imagen").src = itemData.imagen || '';
        document.getElementById("modal-titulo").textContent = itemData.titulo || '';
        document.getElementById("modal-descripcion").textContent = itemData.descripcion || '';
        btnReproducir.href = itemData.url || '#';
        modal.classList.add('active');
        modal.setAttribute('aria-hidden','false');
        btnReproducir.focus();
    }
    function closeModal(){
        modal.classList.remove('active');
        modal.setAttribute('aria-hidden','true');
        if(lastFocusedElement) lastFocusedElement.focus();
    }
    btnVolver.onclick = closeModal;

    // ---------- Interacciones búsqueda (quirúrgico) ----------
    // Toggle del input (solo muestra/oculta, input queda keyboard accessible)
    searchButton.addEventListener('click', function(){
        const isActive = searchInput.classList.toggle('active');
        if(isActive){
            searchInput.setAttribute('tabindex','0');
            searchInput.focus();
        } else {
            searchInput.setAttribute('tabindex','-1');
            // conservar el resultado visible si ya buscó (no hago clear automático)
            // si querés que al cerrar se limpien resultados -> descomentá siguiente línea:
            // clearSearchHighlight();
            searchButton.focus();
        }
    });

    // Enter -> buscar; Escape/Backspace -> limpiar y volver foco a la lupa
    searchInput.addEventListener('keydown', function(e){
        if(e.key === "Enter"){
            e.preventDefault();
            performSearch(searchInput.value.trim());
            return;
        }
        if(e.key === "Escape" || e.key === "Backspace"){
            e.preventDefault();
            searchInput.value = "";
            clearSearchHighlight();
            searchInput.classList.remove('active');
            searchInput.setAttribute('tabindex','-1');
            searchButton.focus();
            return;
        }
        if(e.key === "ArrowDown"){
            // bajar desde el input: enfocamos primer item VISIBLE (no dim)
            e.preventDefault();
            focusFirstVisibleItem();
            return;
        }
    });

    // ---------- Navegación por teclado (flechas) ----------
    function focusFirstVisibleItem(){
        const first = Array.from(document.querySelectorAll('.item-card')).find(c => !c.classList.contains('dim'));
        if(first){ first.focus(); lastFocusedElement = first; }
    }

    document.addEventListener('keydown', function(e){
        const focused = document.activeElement;

        // cuando el modal está activo, manejo básico (igual que antes)
        if(modal.classList.contains('active')){
            if(e.key === "Escape"){ closeModal(); }
            if(e.key === "ArrowLeft"){ btnReproducir.focus(); }
            if(e.key === "ArrowRight"){ btnVolver.focus(); }
            return;
        }

        // desde la lupa (botón) baja al primer item visible
        if(focused === searchButton && e.key === "ArrowDown"){
            e.preventDefault();
            focusFirstVisibleItem();
            return;
        }
        // si foco está en el input, ya manejamos ArrowDown arriba

        // navegación entre items: mantengo tu lógica original pero sin ocultar/mostrar categorías
        let isItemFocused = focused && focused.classList && focused.classList.contains('item-card');
        if(isItemFocused){
            // localizar la fila y posición
            let currentRow = -1, currentIndex = -1;
            for(let r=0; r<allItems.length; r++){
                const idx = allItems[r].indexOf(focused);
                if(idx !== -1){ currentRow = r; currentIndex = idx; break; }
            }
            if(currentRow === -1) return;

            if(e.key === "ArrowRight"){
                e.preventDefault();
                if(currentIndex < allItems[currentRow].length - 1){
                    const nxt = allItems[currentRow][currentIndex+1];
                    if(nxt && !nxt.classList.contains('dim')) { nxt.focus(); lastFocusedElement = nxt; }
                }
                return;
            }
            if(e.key === "ArrowLeft"){
                e.preventDefault();
                if(currentIndex > 0){
                    const prev = allItems[currentRow][currentIndex-1];
                    if(prev && !prev.classList.contains('dim')) { prev.focus(); lastFocusedElement = prev; }
                }
                return;
            }
            if(e.key === "ArrowDown"){
                e.preventDefault();
                if(currentRow < allItems.length - 1){
                    // intentar mantener el same index (o el máximo disponible)
                    const nextRow = allItems[currentRow+1];
                    const targetIndex = Math.min(currentIndex, nextRow.length - 1);
                    // buscar siguiente visible desde targetIndex hacia adelante
                    let candidate = null;
                    for(let i=targetIndex;i<nextRow.length;i++){
                        if(!nextRow[i].classList.contains('dim')){ candidate = nextRow[i]; break; }
                    }
                    if(!candidate){
                        for(let i=targetIndex;i>=0;i--){
                            if(!nextRow[i].classList.contains('dim')){ candidate = nextRow[i]; break; }
                        }
                    }
                    if(candidate){ candidate.focus(); lastFocusedElement = candidate; }
                }
                return;
            }
            if(e.key === "ArrowUp"){
                e.preventDefault();
                if(currentRow > 0){
                    const prevRow = allItems[currentRow-1];
                    const targetIndex = Math.min(currentIndex, prevRow.length - 1);
                    let candidate = null;
                    for(let i=targetIndex;i<prevRow.length;i++){
                        if(!prevRow[i].classList.contains('dim')){ candidate = prevRow[i]; break; }
                    }
                    if(!candidate){
                        for(let i=targetIndex;i>=0;i--){
                            if(!prevRow[i].classList.contains('dim')){ candidate = prevRow[i]; break; }
                        }
                    }
                    if(candidate){ candidate.focus(); lastFocusedElement = candidate; }
                } else {
                    // si está en la primera fila, sube a la lupa (botón)
                    searchButton.focus();
                }
                return;
            }
            if(e.key === "Enter"){
                e.preventDefault();
                // abrir modal con datos del item
                const data = {
                    titulo: focused.getAttribute('data-titulo'),
                    descripcion: focused.getAttribute('data-descripcion'),
                    imagen: focused.getAttribute('data-imagen'),
                    url: focused.getAttribute('data-url')
                };
                lastFocusedElement = focused;
                openModal(data);
            }
        } // end isItemFocused
    });

    // Click en item -> modal (igual que antes)
    document.addEventListener('click', function(e){
        const item = e.target.closest('.item-card');
        if(item){
            const data = {
                titulo: item.getAttribute('data-titulo'),
                descripcion: item.getAttribute('data-descripcion'),
                imagen: item.getAttribute('data-imagen'),
                url: item.getAttribute('data-url')
            };
            lastFocusedElement = item;
            openModal(data);
        }
    });

    // ---------- Inicial */
    window.addEventListener('load', function(){
        // foco inicial en lupa botón
        setTimeout(()=> searchButton.focus(), 300);
        adjustLayoutForSlider();
    });
    window.addEventListener('resize', adjustLayoutForSlider);
    </script>
</body>
</html>
