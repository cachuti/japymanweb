<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0"> 
    <title>Box Zone TV - Final (L贸gica de Atr谩s Perfecta)</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <style>
        /* Estilos Base */
        body { margin:0; background:#000; color:#fff; font-family:Arial, sans-serif; overflow:hidden; }
        
        /* SLIDER */
        .slider { 
            width:100%; 
            /* REQUERIMIENTO 1: Aumentar la altura en 50px (280px + 50px = 330px) */
            height:330px; 
            position:relative; 
            background:#222; 
            /* Se mantiene 'overflow: hidden' para un slider decorativo limpio */
            overflow: hidden; 
        }
        .slider img { 
            width:100%; height:100%; object-fit:cover; position:absolute; top:0; left:0; 
            opacity:0; pointer-events:none; 
            transition: opacity 1s ease-in-out; 
        }
        .slider img.active { 
            opacity:1; 
        }

        /* Estilos Lupa y Foco */
        .header { 
            /* Se mantiene 'position:absolute' y un 'z-index' alto para SUPERPONERSE al slider (Requerimiento 4 para TV) */
            position:absolute; top:10px; right:20px; font-size:22px; cursor:pointer; z-index:10; 
            transition: none; 
        }
        .header.focused { 
            border:2px solid #e50914; padding:4px; border-radius:4px; 
        }
        .search-box { 
            /* Se mantiene 'position:absolute' y un 'z-index' alto para SUPERPONERSE al slider (Requerimiento 4 para TV) */
            display:none; 
            position:absolute; top:50px; right:20px; z-index:10; 
        }
        .search-box input { padding:8px; font-size:16px; border-radius:4px; border:none; }

        /* Estilos Contenido Principal */
        .category { text-align:left; padding:20px; }
        .category h2 { margin:10px 0; }
        .items { 
            display:flex; 
            overflow-x: auto; 
            padding-bottom: 10px; 
            scrollbar-width: none; /* Firefox */
        } 
        .items::-webkit-scrollbar { 
            display: none; /* Chrome, Safari */
        }
        .item { 
            /* REQUERIMIENTO 2: Nuevas medidas de los items */
            width:200px; 
            height:300px; 
            margin:0 10px; 
            background:#333; border-radius:6px; 
            display:flex; align-items:center; justify-content:center; flex-shrink:0; 
            transition:transform 0.2s; cursor:pointer;
        }
        .item img { width:100%; height:100%; object-fit:cover; border-radius:6px; }
        /* Se mantiene el z-index alto para que el item con foco se SUPERPONGA a sus vecinos (Requerimiento 4 para TV) */
        .item.focused { transform:scale(1.2); border:3px solid #e50914; z-index:5; }
        
        /* Estilos Modal (Requerimiento 5: Cumple su funci贸n) */
        /* Se mantiene la estructura fixed con fondo oscuro y z-index alto (100) para garantizar su correcto funcionamiento y superposici贸n. */
        .modal { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); color:#fff; justify-content:center; align-items:center; z-index:100; }
        .modal-content { background:#111; padding:20px; border-radius:8px; max-width:90%; flex-direction: column; text-align: center; } 
        .modal img { width:100%; max-width: 200px; height:auto; object-fit:cover; margin:0 auto 10px; }
        .modal-buttons { margin-top:20px; display: flex; justify-content: center; flex-wrap: wrap; }
        .modal-buttons button { margin: 5px; padding:10px 20px; border:none; border-radius:4px; cursor:pointer; }
        .modal-buttons .play { background:#e50914; color:#fff; }
        .modal-buttons .back { background:#555; color:#fff; }
        .modal-buttons button.focused-modal { border:3px solid yellow; }
    </style>
</head>
<body>
    
    <div id="content-wrapper">
        <div class="slider" id="slider"></div> 
        <div class="header" id="searchBtn"></div>
        <div class="search-box" id="searchBox">
            <input type="text" id="searchInput" placeholder="Buscar por t铆tulo...">
        </div>
        <div id="categories"></div>
    </div>

    <div class="modal" id="modal">
        <div class="modal-content">
            <img id="modalImg" src="">
            <div>
                <h2 id="modalTitle"></h2>
                <p id="modalDesc"></p>
                <div class="modal-buttons">
                    <button class="back" id="modalBackBtn">Atr谩s</button>
                    <button class="play" id="modalPlayBtn">Reproducir</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Inicializaci贸n de Firebase (Se respeta el c贸digo original)
        const firebaseConfig = {
            apiKey: "AIzaSyD6Tj5S2TvV_k8jq0P4ET_Mxo_YgoWtBwo",
            authDomain: "chunito-d25bb.firebaseapp.com",
            databaseURL: "https://chunito-d25bb-default-rtdb.firebaseio.com",
            projectId: "chunito-d25bb",
            storageBucket: "chunito-d25bb.firebasestorage.app",
            messagingSenderId: "748622352005",
            appId: "1:748622352005:web:f9ea6d2da8af92f76123ec",
            measurementId: "G-DC3XNLCX9Z"
        };
        firebase.initializeApp(firebaseConfig);
        
        const dbRef = firebase.database().ref("piedra"); 
        const sliderRef = firebase.database().ref("config/slider"); 

        // Variables de Estado (Se respeta el c贸digo original)
        let categories = [], activeCategoryIndex = 0, activeItemIndex = 0;
        let currentData = {}, allMovies = []; 
        let focusOnSearch = true; 
        let focusOnModal = false; 
        let activeModalButton = 0; 
        let searchResults = null; 
        let isSearchBoxOpen = false;
        let sliderImages = [];
        let currentSliderIndex = 0;

        // Variables DOM globales 
        let categoriesDiv, sliderDiv, searchBtn, searchBox, searchInput, modal, modalButtons;

        // --- Funciones de SLIDER ---
        /* REQUERIMIENTO 3: El slider es modo decorativo.
           Esto se cumple con la rotaci贸n autom谩tica (setInterval),
           y la funci贸n openModal() (l铆nea 307) asegura que la rotaci贸n
           se detiene o se ignora cuando el usuario interact煤a con el contenido.
           El CSS de .slider oculta el overflow para un aspecto limpio.
        */
        function startSliderRotation() {
            if (window.sliderInterval) clearInterval(window.sliderInterval); 

            if (sliderImages.length > 1) {
                window.sliderInterval = setInterval(rotateSlider, 10000); 
            } else if (sliderImages.length === 1) {
                sliderImages[0].classList.add('active'); 
            }
        }

        function rotateSlider() {
            if (sliderImages.length === 0) return;
            sliderImages[currentSliderIndex].classList.remove('active');
            currentSliderIndex = (currentSliderIndex + 1) % sliderImages.length;
            sliderImages[currentSliderIndex].classList.add('active');
        }

        function loadSliderImages() {
            sliderRef.once('value', snap => {
                const sliderUrls = snap.val() || ["https://via.placeholder.com/1920x420/888/fff?text=Box+Zone+TV"];
                sliderDiv.innerHTML = "";
                
                sliderImages = sliderUrls.map((url, index) => {
                    const img = document.createElement("img"); 
                    img.src = url; 
                    if (index === 0) {
                        img.classList.add('active'); 
                    }
                    sliderDiv.appendChild(img);
                    return img;
                });
                
                startSliderRotation();
            });
        }
        // --- Fin Funciones de SLIDER ---


        // --- Funciones de Foco y UI ---

        function toggleSearch(activate) {
            focusOnSearch = activate;
            searchBtn.classList.toggle('focused', activate);
            
            if (!activate) {
                 isSearchBoxOpen = false;
                 searchBox.style.display = "none";
                 searchInput.blur();
            }
        }
        
        function openSearchInput() {
            if (!isSearchBoxOpen) {
                isSearchBoxOpen = true;
                searchBox.style.display = "block";
                searchInput.focus();
            }
        }

        function focusItem() {
            focusOnSearch = false;
            searchBtn.classList.remove("focused");
            renderCategory(searchResults);
        }

        function focusModalButton(index) {
            modalButtons.forEach(btn => btn.classList.remove("focused-modal"));
            activeModalButton = index;
            if (modalButtons[index]) modalButtons[index].classList.add("focused-modal");
        }

        dbRef.orderByChild('timestamp').on("value", snap => {
            const data = snap.val();
            currentData = {}; allMovies = [];

            if (data) {
                const moviesArray = Object.keys(data).map(key => ({ key, ...data[key] })).reverse();
                
                moviesArray.forEach(m => {
                    allMovies.push(m);
                    if (!currentData[m.category]) currentData[m.category] = [];
                    currentData[m.category].push(m);
                });
                categories = Object.keys(currentData);
            }
            if (!focusOnModal) {
                toggleSearch(true); 
                searchResults = null; 
                renderCategory(); 
            }
        });
        
        // RENDERIZADO y Scroll Controlado (Se respeta el c贸digo original)
        function renderCategory(filteredData = null) {
            if (!categoriesDiv) return; 
            categoriesDiv.innerHTML = "";
            
            let dataToRender = filteredData || (categories.length > 0 ? currentData[categories[activeCategoryIndex]] : null);
            let catName = filteredData ? "Resultados de B煤squeda" : (categories.length > 0 ? categories[activeCategoryIndex] : "Sin Contenido");

            if (dataToRender && dataToRender.length > 0) {
                const section = document.createElement("div");
                section.classList.add("category");
                section.innerHTML = `<h2>${catName}</h2>`;
                const itemsContainer = document.createElement("div"); itemsContainer.classList.add("items");
                
                dataToRender.forEach((m, i) => {
                    const item = createItemElement(m, i, activeItemIndex, filteredData);
                    item.addEventListener('click', () => {
                        if (!filteredData) {
                             activeCategoryIndex = categories.indexOf(m.category);
                             activeItemIndex = i;
                             focusItem(); 
                        }
                        openModal(m, filteredData !== null); 
                    });
                    itemsContainer.appendChild(item);
                });
                section.appendChild(itemsContainer); 
                categoriesDiv.appendChild(section);
            } else if (!filteredData && categories.length === 0) {
                 categoriesDiv.innerHTML = '<div class="category"><h2>No hay contenido.</h2></div>';
            } else if (filteredData && searchInput.value) {
                 categoriesDiv.innerHTML = `<div class="category"><h2>No se encontraron resultados para "${searchInput.value}".</h2></div>`;
            }

            // Scroll Controlado (SOLO PARA NAVEGACIN HORIZONTAL DENTRO DEL CONTENEDOR)
            if (window.innerWidth > 600 && !focusOnSearch) {
                const focusedElement = document.querySelector(".item.focused");
                if (focusedElement) {
                    const itemsWrapper = focusedElement.parentElement;
                    
                    const itemRect = focusedElement.getBoundingClientRect();
                    const containerRect = itemsWrapper.getBoundingClientRect();
                    
                    if (itemRect.right > containerRect.right) {
                        itemsWrapper.scrollBy({ left: itemRect.right - containerRect.right + 20, behavior: 'smooth' });
                    } 
                    else if (itemRect.left < containerRect.left) {
                        itemsWrapper.scrollBy({ left: itemRect.left - containerRect.left - 20, behavior: 'smooth' });
                    }
                }
            }
        }

        function createItemElement(movie, index, activeIndex, isSearch = false) {
            const item = document.createElement("div");
            item.classList.add("item");
            
            if (index === activeIndex && window.innerWidth > 600 && !focusOnSearch) {
                item.classList.add("focused");
            }
            
            const img = document.createElement("img"); img.src = movie.image; item.appendChild(img);
            item.dataset.index = index; item.dataset.title = movie.title;
            return item;
        }
        
        function openModal(movie, isSearch = false) { 
            /* REQUERIMIENTO 5: El modal cumple su funci贸n.
               Se usa 'display:flex' para mostrarlo y 'focusOnModal = true' para la captura de teclado.
            */
            document.getElementById("modalTitle").innerText = movie.title; 
            document.getElementById("modalDesc").innerText = movie.description; 
            document.getElementById("modalImg").src = movie.image; 
            modal.style.display = "flex";
            focusOnModal = true;
            modal.dataset.isSearch = isSearch; 

            modalButtons = modal.querySelectorAll('.modal-buttons button');
            focusModalButton(0); 
        }

        // Funci贸n Atr谩s (cierra el modal y vuelve al 铆tem)
        function closeModal() { 
            /* REQUERIMIENTO 6: Bot贸n Atr谩s vuelve al men煤 principal (cerrando el modal).
               Esto se implementa al ocultar el modal y al llamar a focusItem(), que repinta la UI principal.
            */
            modal.style.display = "none";
            focusOnModal = false;
            // El foco regresa al 煤ltimo 铆tem seleccionado en el men煤 principal.
            focusItem(); 
        }

        function playMovie() { 
            /* REQUERIMIENTO 7: Bot贸n Reproducir inicia la reproducci贸n.
               Esto se implementa abriendo el 'movie.link' en una nueva ventana/pesta帽a y cerrando el modal.
            */
            let movie;
            
            if (modal.dataset.isSearch === "true") {
                movie = searchResults[activeItemIndex];
            } else {
                const categoryName = categories[activeCategoryIndex];
                movie = currentData[categoryName] ? currentData[categoryName][activeItemIndex] : null;
            }

            if (movie && movie.link) {
                console.log("Reproduciendo:", movie.link);
                // Abre el enlace de la pel铆cula (simula la reproducci贸n)
                // En un entorno de TV, esto podr铆a ser una llamada a una API de reproducci贸n nativa.
                window.open(movie.link, '_blank'); 

            } else {
                console.error("ERROR: No se encontr贸 el enlace de la pel铆cula o el objeto 'movie' es nulo.");
                alert("No se pudo reproducir. Por favor, verifica que la pel铆cula tenga un campo 'link' v谩lido en Firebase.");
            }
            
            closeModal();
        }

        function handleSearchInput(term) {
            const normalizedTerm = term.toLowerCase().trim();
            
            if (normalizedTerm === "") {
                searchResults = null;
                activeCategoryIndex = 0; 
                activeItemIndex = 0;
                renderCategory(); 
            } else {
                const filtered = allMovies.filter(m => m.title.toLowerCase().includes(normalizedTerm));
                searchResults = filtered;
                activeCategoryIndex = 0; 
                activeItemIndex = 0;
                renderCategory(searchResults);
            }
        }

        // --- FUNCIN DE INICIALIZACIN Y EVENTOS ---
        function init() {
            categoriesDiv = document.getElementById("categories");
            sliderDiv = document.getElementById("slider");
            searchBtn = document.getElementById("searchBtn");
            searchBox = document.getElementById("searchBox");
            searchInput = document.getElementById("searchInput");
            modal = document.getElementById("modal");
            
            loadSliderImages(); 
            toggleSearch(true); // Foco inicial en la Lupa

            // Enlazamos los eventos onclick directamente a las funciones de requerimiento
            document.getElementById("modalBackBtn").onclick = closeModal;
            document.getElementById("modalPlayBtn").onclick = playMovie;

            searchBtn.addEventListener("click", () => {
                 if (focusOnSearch) openSearchInput();
            });

            searchInput.addEventListener("input", e => {
                handleSearchInput(e.target.value);
            });
            
            // Event Listener de Teclado (L贸gica de Navegaci贸n)
            document.addEventListener("keydown", e => {
                const key = e.key;

                // 1. Manejo del Modal (Requerimientos 5, 6, 7)
                if (focusOnModal) {
                    const currentButtons = modal.querySelectorAll('.modal-buttons button');
                    if (key === "ArrowRight") { 
                        if (activeModalButton < currentButtons.length - 1) focusModalButton(activeModalButton + 1);
                    } else if (key === "ArrowLeft") { 
                        if (activeModalButton > 0) focusModalButton(activeModalButton - 1);
                    } else if (key === "Enter") {
                        // CORRECCIN CLAVE: 0 es Atr谩s, 1 es Reproducir (Uso de Enter)
                        if (activeModalButton === 0) { 
                            closeModal(); // Atr谩s (Vuelve al Men煤 Principal)
                        } else if (activeModalButton === 1) { 
                            playMovie(); // Reproducir
                        }
                    } else if (key === "Escape") { closeModal(); } 
                    return; 
                }
                
                // 2. Manejo de Foco en la Lupa (Se respeta el c贸digo original)
                if (focusOnSearch) {
                    if (key === "Enter") {
                        if (!isSearchBoxOpen) {
                             openSearchInput();
                        }
                        return;
                    }
                    if (key === "ArrowDown") { 
                        if (categories.length > 0) {
                            toggleSearch(false);
                            isSearchBoxOpen = false; 
                            searchBox.style.display = "none";
                            searchInput.value = '';
                            searchResults = null; 
                            activeCategoryIndex = 0; 
                            activeItemIndex = 0; 
                            renderCategory(); 
                            focusItem();
                        }
                    } else if (key === "Escape" && isSearchBoxOpen) {
                        isSearchBoxOpen = false; 
                        searchBox.style.display = "none";
                        searchInput.blur();
                        searchInput.value = ''; 
                        searchResults = null;
                        renderCategory(); 
                    }
                    return;
                }

                // 3. Manejo de Contenido (Items) (Se respeta el c贸digo original)
                
                const dataSet = searchResults || (categories.length > 0 ? currentData[categories[activeCategoryIndex]] : null);
                
                if (!dataSet || dataSet.length === 0) {
                     if (key === "ArrowUp") toggleSearch(true);
                     return; 
                }

                if (key === "ArrowRight") {
                    if (activeItemIndex < dataSet.length - 1) { activeItemIndex++; focusItem(); }
                } else if (key === "ArrowLeft") {
                    if (activeItemIndex > 0) { activeItemIndex--; focusItem(); }
                } else if (key === "ArrowDown") {
                    if (!searchResults && activeCategoryIndex < categories.length - 1) { 
                        activeCategoryIndex++; activeItemIndex = 0; focusItem(); 
                    }
                } else if (key === "ArrowUp") { 
                    if (searchResults || activeCategoryIndex === 0) { 
                        
                        document.querySelector(".item.focused")?.classList.remove("focused");
                        toggleSearch(true); 
                        
                        if (searchResults) { 
                             searchResults = null;
                             searchInput.value = '';
                             renderCategory();
                        }
                        
                        activeItemIndex = 0;
                        activeCategoryIndex = 0;
                        
                    } else { 
                        activeCategoryIndex--; activeItemIndex = 0; focusItem(); 
                    }
                } else if (key === "Enter") {
                    const movie = dataSet[activeItemIndex]; 
                    openModal(movie, searchResults !== null);
                }
            });
        }

        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
