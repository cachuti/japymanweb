<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0"> 
    <title>Box Zone TV - Dise침o Original (M칰ltiples Filas con Scroll)</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <style>
        /* ---------------------------------------------------- */
        /* --------- BASE Y LAYOUT (EST츼TICO VERTICAL) -------- */
        /* ---------------------------------------------------- */
        html, body { 
            margin:0; padding:0; background:#000; color:#fff; 
            font-family:Arial, sans-serif; 
            height: 100%; width: 100%;
            overflow: hidden; /* Evita scroll vertical en la ventana principal */
        }
        
        #content-wrapper {
            display: flex;
            flex-direction: column; 
            height: 100%;
        }

        /* ---------------------------------------------------- */
        /* --------- SLIDER / DESTACADO ----------------------- */
        /* ---------------------------------------------------- */
        .slider { 
            width:100%; 
            height: 330px; 
            position:relative; 
            background:#111; 
            overflow: hidden; 
            flex-shrink: 0; 
            z-index: 10; 
        }
        .slider img { 
            width:100%; height:100%; object-fit:cover; position:absolute; top:0; left:0; 
            opacity:0; pointer-events:none; 
            transition: opacity 1s ease-in-out; 
        }
        .slider img.active { 
            opacity:1; 
        }

        /* ---------------------------------------------------- */
        /* --------- B칔SQUEDA Y LUPA (Vuelve a ser flotante) -- */
        /* ---------------------------------------------------- */
        .header { 
            position:absolute; top:20px; right:30px; font-size:24px; cursor:pointer; 
            z-index: 200; 
            padding: 8px; border-radius: 8px;
            transition: all 0.2s ease;
        }
        .header.focused { 
            border:2px solid #e50914; 
            transform: scale(1.1);
            background: rgba(229, 9, 20, 0.2);
        }
        .search-box { 
            display:none; position:absolute; top:70px; right:30px; z-index:200; 
            background: rgba(0,0,0,0.8); padding:15px; border-radius:10px;
        }
        .search-box input { 
            padding:12px; font-size:18px; border-radius:6px; border:none; 
            background:#333; color:#fff; width: 300px;
        }

        /* ---------------------------------------------------- */
        /* --------- CONTENEDOR DE CATEGOR칈AS ----------------- */
        /* ---------------------------------------------------- */
        #categories {
            flex-grow: 1; 
            overflow-y: auto; /* Habilita el scroll vertical para las categor칤as */
            position: relative; 
            
            /* Mantiene la superposici칩n sobre el slider */
            margin-top: -100px; 
            padding-top: 100px; 
            padding-bottom: 20px; 
            
            scrollbar-width: none; 
            z-index: 20; 
        }
        #categories::-webkit-scrollbar { display: none; }

        /* Estilos de Categor칤a e 칈tems */
        .category { 
            text-align:left; 
            padding:10px 0 10px 20px; 
        } 
        .category h2 { 
            margin:0 0 10px 0; 
            font-size: 1.4em; 
        }
        .items { 
            display:flex; 
            overflow-x: auto; 
            padding-bottom: 10px; 
            scrollbar-width: none; 
            position: relative; 
            z-index: 50; 
        } 
        .items::-webkit-scrollbar { 
            display: none; 
        }
        .item { 
            /* Tama침os compactos de la versi칩n optimizada */
            width:150px; 
            height:220px; 
            margin:0 8px; 
            background:#333; border-radius:6px; 
            display:flex; align-items:center; justify-content:center; flex-shrink:0; 
            transition:transform 0.2s, box-shadow 0.2s; cursor:pointer;
            position: relative;
        }
        .item img { width:100%; height:100%; object-fit:cover; border-radius:6px; }
        .item.focused { 
            transform:scale(1.25); 
            border:3px solid #e50914; 
            box-shadow: 0 0 10px rgba(229, 9, 20, 0.5);
            z-index: 60; 
        }
        
        /* ---------------------------------------------------- */
        /* --------- MODAL (Detalles de Pel칤cula) ------------- */
        /* ---------------------------------------------------- */
        .modal { 
            display:none; position:fixed; top:0; left:0; width:100%; height:100%; 
            background:rgba(0,0,0,0.9); justify-content:center; align-items:center; z-index:1000; 
        }
        .modal-content { 
            background:#1a1a1a; padding:30px; border-radius:10px; 
            max-width:70%; display:flex; gap: 30px; 
            box-shadow: 0 5px 20px rgba(0,0,0,0.5);
        } 
        .modal-image-container { flex-shrink: 0; }
        .modal-image-container img { width:200px; height:300px; object-fit:cover; border-radius:6px; }
        .modal-details { text-align: left; }
        .modal h2 { margin-top:0; font-size: 2em; }
        .modal p { color:#ccc; }
        
        .modal-buttons { margin-top:20px; display: flex; gap: 15px; }
        .modal-buttons button { 
            padding:12px 25px; border:none; border-radius:4px; cursor:pointer; 
            font-size:1.1em; transition: transform 0.2s;
        }
        .modal-buttons .play { background:#e50914; color:#fff; }
        .modal-buttons .back { background:#555; color:#fff; }
        .modal-buttons button.focused-modal { border:3px solid yellow; transform: scale(1.05); }
    </style>
</head>
<body>
    
    <div id="content-wrapper">
        <div class="slider" id="slider"></div> 
        <div class="header" id="searchBtn">游댌</div> 
        <div class="search-box" id="searchBox">
            <input type="text" id="searchInput" placeholder="Buscar por t칤tulo...">
        </div>
        <div id="categories"></div>
    </div>

    <div class="modal" id="modal">
        <div class="modal-content">
            <div class="modal-image-container">
                <img id="modalImg" src="">
            </div>
            <div class="modal-details">
                <h2 id="modalTitle"></h2>
                <p id="modalDesc"></p>
                <div class="modal-buttons">
                    <button class="play" id="modalPlayBtn">Reproducir</button>
                    <button class="back" id="modalBackBtn">Atr치s</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Inicializaci칩n de Firebase (No cambia)
        const firebaseConfig = {
            apiKey: "AIzaSyD6Tj5S2TvV_k8jq0P4ET_Mxo_YgoWtBwo",
            authDomain: "chunito-d25bb.firebaseapp.com",
            databaseURL: "https://chunito-d25bb-default-rtdb.firebaseio.com",
            projectId: "chunito-d25bb",
            storageBucket: "chunito-d25bb.firebasestorage.app",
            messagingSenderId: "748622352005",
            appId: "1:748622352005:web:f9ea6d2da8af92f76123ec",
            measurementId: "G-DC3XNLCX9Z"
        };
        firebase.initializeApp(firebaseConfig);
        
        const dbRef = firebase.database().ref("piedra"); 
        const sliderRef = firebase.database().ref("config/slider"); 

        // Variables de Estado
        let categories = [], activeCategoryIndex = 0, activeItemIndex = 0;
        let currentData = {}, allMovies = []; 
        let focusArea = 'slider'; // Vuelve a ser 'slider' o 'items'
        let activeModalButton = 0; 
        let searchResults = null; 
        let isSearchBoxOpen = false;
        let sliderImages = [];
        let currentSliderIndex = 0;

        // Variables DOM globales 
        let categoriesDiv, sliderDiv, searchBtn, searchBox, searchInput, modal, modalButtons;

        // --- Carga de Datos y Inicializaci칩n ---
        function loadData() {
            dbRef.orderByChild('timestamp').on("value", snap => {
                const data = snap.val();
                currentData = {}; allMovies = [];

                if (data) {
                    const moviesArray = Object.keys(data).map(key => ({ key, ...data[key] })).reverse();
                    
                    moviesArray.forEach(m => {
                        allMovies.push(m);
                        if (!currentData[m.category]) currentData[m.category] = [];
                        currentData[m.category].push(m);
                    });
                    categories = Object.keys(currentData);
                }
                if (focusArea !== 'modal') {
                    setFocus('slider'); 
                }
            });

            sliderRef.once('value', snap => {
                const sliderUrls = snap.val() || ["https://via.placeholder.com/1920x330/888/fff?text=Pelicula+Destacada"];
                sliderDiv.innerHTML = "";
                
                sliderImages = sliderUrls.map((url, index) => {
                    const img = document.createElement("img"); 
                    img.src = url; 
                    if (index === 0) {
                        img.classList.add('active'); 
                    }
                    sliderDiv.appendChild(img);
                    return img;
                });
                startSliderRotation();
            });
        }

        // --- Funciones de SLIDER (Rotaci칩n) ---
        function startSliderRotation() {
            if (window.sliderInterval) clearInterval(window.sliderInterval); 
            if (sliderImages.length > 1) {
                window.sliderInterval = setInterval(rotateSlider, 8000); 
            } else if (sliderImages.length === 1) {
                sliderImages[0].classList.add('active'); 
            }
        }

        function rotateSlider() {
            if (sliderImages.length === 0) return;
            sliderImages[currentSliderIndex].classList.remove('active');
            currentSliderIndex = (currentSliderIndex + 1) % sliderImages.length;
            sliderImages[currentSliderIndex].classList.add('active');
        }

        // --- Manejo de Foco ---
        function setFocus(area) {
            // Limpia focos anteriores
            document.querySelectorAll('.focused, .focused-modal').forEach(el => el.classList.remove('focused', 'focused-modal'));
            
            focusArea = area;
            
            if (area === 'slider') {
                searchBtn.classList.add("focused");
                isSearchBoxOpen = false;
                searchBox.style.display = "none";
                searchInput.blur();
                renderCategory(); // Renderiza todas las categor칤as
            } else if (area === 'items') {
                renderCategory(searchResults); // Renderiza todas (o solo resultados) y aplica el foco
            } else if (area === 'search') {
                searchBtn.classList.add("focused");
                openSearchInput();
            } else if (area === 'modal') {
                modal.style.display = 'flex';
                focusModalButton(0);
            }
        }

        function openSearchInput() {
            if (!isSearchBoxOpen) {
                isSearchBoxOpen = true;
                searchBox.style.display = "block";
                searchInput.focus();
            }
        }

        function focusModalButton(index) {
            modalButtons.forEach(btn => btn.classList.remove("focused-modal"));
            activeModalButton = index;
            if (modalButtons[index]) modalButtons[index].classList.add("focused-modal");
        }
        
        // --- Renderizado y Scroll (Vuelve a renderizar TODAS las filas) ---
        function renderCategory(filteredData = null) {
            if (!categoriesDiv) return; 
            categoriesDiv.innerHTML = "";
            
            const catsToRender = filteredData ? 
                [{ name: `Resultados para "${searchInput.value}"`, data: filteredData }] : 
                categories.map(name => ({ name: name, data: currentData[name] }));
            
            if (catsToRender.length === 0 && !filteredData) {
                categoriesDiv.innerHTML = '<div class="category"><h2>No hay contenido.</h2></div>';
                return;
            } else if (catsToRender.length === 0 && filteredData) {
                 categoriesDiv.innerHTML = `<div class="category"><h2>No se encontraron resultados para "${searchInput.value}".</h2></div>`;
                 return;
            }

            // Renderizar todas las categor칤as
            catsToRender.forEach((cat, catIndex) => {
                const section = document.createElement("div");
                section.classList.add("category");
                section.dataset.categoryIndex = catIndex;

                section.innerHTML = `<h2>${cat.name}</h2>`;
                const itemsContainer = document.createElement("div"); 
                itemsContainer.classList.add("items");
                
                cat.data.forEach((m, itemIndex) => {
                    // El foco solo se aplica si estamos en la zona 'items' y en la categor칤a/칤tem correcto
                    const isFocused = focusArea === 'items' && catIndex === activeCategoryIndex && itemIndex === activeItemIndex;
                    const item = createItemElement(m, itemIndex, isFocused);
                    item.addEventListener('click', () => {
                         activeCategoryIndex = catIndex;
                         activeItemIndex = itemIndex;
                         openModal(m, filteredData !== null); 
                    });
                    itemsContainer.appendChild(item);
                });
                section.appendChild(itemsContainer); 
                categoriesDiv.appendChild(section);
            });

            // Control de scroll y foco
            if (focusArea === 'items') {
                const focusedElement = document.querySelector(".item.focused");
                if (focusedElement) {
                    focusedElement.scrollIntoView({ 
                        behavior: 'smooth', 
                        inline: 'center', 
                        block: 'nearest' 
                    });
                    
                    // Scroll vertical para que la fila enfocada sea visible
                    const categoryWrapper = focusedElement.closest('.category');
                    if (categoryWrapper) {
                        // Ajusta el scroll para mantener la categor칤a visible con un margen
                        const offset = 80; 
                        categoriesDiv.scrollTop = categoryWrapper.offsetTop - offset; 
                    }
                }
            }
        }

        function createItemElement(movie, index, isFocused) {
            const item = document.createElement("div");
            item.classList.add("item");
            if (isFocused) { item.classList.add("focused"); }
            
            const img = document.createElement("img"); img.src = movie.image; item.appendChild(img);
            item.dataset.index = index; item.dataset.title = movie.title;
            return item;
        }

        // --- Modal y Reproducci칩n ---
        function openModal(movie, isSearch = false) { 
            document.getElementById("modalTitle").innerText = movie.title; 
            document.getElementById("modalDesc").innerText = movie.description; 
            document.getElementById("modalImg").src = movie.image; 
            
            modal.style.display = "flex";
            focusArea = 'modal';
            modal.dataset.isSearch = isSearch; 
            modalButtons = modal.querySelectorAll('.modal-buttons button');
            focusModalButton(0); 
        }

        function closeModal() { 
            modal.style.display = "none";
            // Regresa a la zona de 칤tems o al slider, manteniendo el 칤ndice
            if (activeCategoryIndex === 0 && activeItemIndex === 0) {
                 setFocus('slider'); 
            } else {
                 setFocus('items'); 
            }
        }

        function playMovie() { 
            let movie;
            const isSearch = modal.dataset.isSearch === "true";
            
            if (isSearch) {
                movie = searchResults[activeItemIndex];
            } else {
                const categoryName = categories[activeCategoryIndex];
                movie = currentData[categoryName] ? currentData[categoryName][activeItemIndex] : null;
            }

            if (movie && movie.link) {
                console.log("Reproduciendo:", movie.link);
                // Aqu칤 ir칤a la llamada a tu reproductor
                alert(`Reproduciendo: ${movie.title}\nEnlace: ${movie.link}`);
            } else {
                alert("ERROR: No se encontr칩 el enlace de la pel칤cula.");
            }
            closeModal();
        }

        function handleSearchInput(term) {
            const normalizedTerm = term.toLowerCase().trim();
            
            if (normalizedTerm === "") {
                searchResults = null;
                activeCategoryIndex = 0; activeItemIndex = 0;
                setFocus('slider'); 
            } else {
                const filtered = allMovies.filter(m => m.title.toLowerCase().includes(normalizedTerm));
                searchResults = filtered;
                activeCategoryIndex = 0; // En b칰squeda, solo hay una categor칤a (resultados)
                activeItemIndex = 0;
                setFocus('items'); 
            }
        }

        // --- L칩gica de Teclado (Navegaci칩n Vertical Restaurada) ---
        document.addEventListener("keydown", e => {
            const key = e.key;

            if (focusArea === 'modal') {
                const currentButtons = modal.querySelectorAll('.modal-buttons button');
                if (key === "ArrowRight") { if (activeModalButton < currentButtons.length - 1) focusModalButton(activeModalButton + 1); } 
                else if (key === "ArrowLeft") { if (activeModalButton > 0) focusModalButton(activeModalButton - 1); } 
                else if (key === "Enter") {
                    if (currentButtons[activeModalButton] === document.getElementById("modalPlayBtn")) { playMovie(); } 
                    else { closeModal(); }
                } else if (key === "Escape") { closeModal(); } 
                return; 
            }

            if (focusArea === 'slider') {
                if (key === "Enter") { openSearchInput(); }
                else if (key === "ArrowDown" && categories.length > 0) {
                    activeCategoryIndex = 0; activeItemIndex = 0;
                    setFocus('items');
                }
                return;
            }
            
            if (focusArea === 'items') {
                // Obtiene el set de datos correcto (categor칤a actual o resultados de b칰squeda)
                const dataSet = searchResults || (categories.length > 0 ? currentData[categories[activeCategoryIndex]] : null);
                const totalCategories = searchResults ? 1 : categories.length; // 1 si es b칰squeda, sino el total real.
                
                if (!dataSet || dataSet.length === 0) {
                     if (key === "ArrowUp") setFocus('slider');
                     return; 
                }

                if (key === "ArrowRight") {
                    if (activeItemIndex < dataSet.length - 1) { activeItemIndex++; setFocus('items'); }
                } else if (key === "ArrowLeft") {
                    if (activeItemIndex > 0) { activeItemIndex--; setFocus('items'); }
                } else if (key === "ArrowDown") {
                    // Navega a la siguiente categor칤a (fila) si no estamos en b칰squeda
                    if (!searchResults && activeCategoryIndex < totalCategories - 1) { 
                        activeCategoryIndex++; activeItemIndex = 0; setFocus('items'); 
                    }
                } else if (key === "ArrowUp") { 
                    // Navega a la categor칤a anterior o al slider
                    if (searchResults || activeCategoryIndex === 0) { 
                        setFocus('slider');
                        searchResults = null; // Limpia la b칰squeda si volvemos arriba
                        searchInput.value = '';
                    } else { 
                        activeCategoryIndex--; activeItemIndex = 0; setFocus('items'); 
                    }
                } else if (key === "Enter") {
                    const movie = dataSet[activeItemIndex]; 
                    openModal(movie, searchResults !== null);
                }
            }
        });

        document.addEventListener('DOMContentLoaded', () => {
            categoriesDiv = document.getElementById("categories");
            sliderDiv = document.getElementById("slider");
            searchBtn = document.getElementById("searchBtn");
            searchBox = document.getElementById("searchBox");
            searchInput = document.getElementById("searchInput");
            modal = document.getElementById("modal");
            modalButtons = modal.querySelectorAll('.modal-buttons button'); 

            document.getElementById("modalBackBtn").onclick = closeModal;
            document.getElementById("modalPlayBtn").onclick = playMovie;
            searchBtn.addEventListener("click", () => { setFocus('slider'); openSearchInput(); });
            searchInput.addEventListener("input", e => { handleSearchInput(e.target.value); });
            
            loadData();
        });
    </script>
</body>
</html>
